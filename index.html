<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 1. GANTI JUDUL DI SINI -->
    <title>StructureFlow v3.5 — Edisi Angga Conni Saputra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @keyframes fadeIn { from{opacity:0}to{opacity:1} }
        @keyframes slideUp { from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1} }
        @keyframes slideRight { from{transform:translateX(12px);opacity:0}to{transform:translateX(0);opacity:1} }
        @keyframes scaleIn { from{transform:scale(.96);opacity:0}to{transform:scale(1);opacity:1} }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 10%, 30%, 50%, 70%, 90% {transform: translateX(-4px);} 20%, 40%, 60%, 80% {transform: translateX(4px);} }
        .anim-fade { animation: fadeIn .35s ease both; }
        .anim-up { animation: slideUp .4s cubic-bezier(.22,1,.36,1) both; }
        .anim-right { animation: slideRight .3s ease both; }
        .anim-scale { animation: scaleIn .35s cubic-bezier(.22,1,.36,1) both; }
        .anim-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .delay-1 { animation-delay: .05s; }
        .delay-2 { animation-delay: .1s; }
        .delay-3 { animation-delay: .15s; }
        .delay-4 { animation-delay: .2s; }
        @media print { .no-print{display:none!important} }
        .prose-card h1,.prose-card h2,.prose-card h3{margin:.8em 0 .4em;font-weight:600;line-height:1.3}
        .prose-card h3{font-size:1rem;color:#1e40af}
        .prose-card p{margin-bottom:.7em;line-height:1.65;color:#374151}
        .prose-card ul,.prose-card ol{padding-left:1.4em;margin-bottom:.7em}
        .prose-card li{margin-bottom:.3em;color:#374151}
        .prose-card strong{color:#111827;font-weight:600}
        .prose-card em{color:#4b5563}
        .prose-card blockquote{border-left:3px solid #6366f1;padding:.5em 1em;background:#f5f3ff;margin:1em 0;border-radius:0 6px 6px 0;font-style:italic;color:#4338ca}
        
        /* AI Specific Styles */
        .ai-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        .ai-thinking { background: linear-gradient(270deg, #3b82f6, #8b5cf6, #3b82f6); background-size: 200% 200%; animation: gradient-move 2s ease infinite; }
        @keyframes gradient-move { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
<div id="root"></div>

<script type="text/babel" data-type="module">
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { createRoot } from 'react-dom/client';
import {
    Layout, Plus, Trash2, Edit3, Save, Upload, FileText,
    ArrowUp, ArrowDown, Globe, BookOpen, ChevronLeft,
    Bold, Italic, List, Printer, FolderOpen, Mail,
    Sparkles, GraduationCap, Scale, Newspaper, Megaphone,
    PenTool, BarChart2, Search, Tag, CheckCircle2,
    AlertCircle, Lightbulb, Library, Layers, Cpu, X,
    ChevronDown, ChevronRight, Star, Zap, Info,
    Brain, MessageSquare, Undo, Lock, Unlock, AlertTriangle, Loader2, Download,
    RefreshCw, Terminal
} from 'lucide-react';

/* ═══════════════════════════════════════════════════════════════
   AI BRIDGE — Resilience Layer (FALLBACK ENABLED)
   Sekarang mendukung bahasa dinamis (EN/ID) di setiap prompt.
═══════════════════════════════════════════════════════════════ */

const AI_BRIDGE = {
    models: [
        'gemini-2.5-flash-preview-09-2025',
        'gemini-2.0-flash',
        'gemini-1.5-flash-latest',
        'gemini-1.5-flash',
        'gemini-1.5-pro'
    ],
    hasKey: (key) => !!key && key.length > 10,
    async generate(prompt, apiKey, onProgress) {
        if (!this.hasKey(apiKey)) throw new Error("API Key Tidak Ditemukan atau Tidak Valid");
        let lastError = null;
        for (const model of this.models) {
            try {
                if (onProgress) onProgress(`Mencoba model: ${model}...`);
                const result = await this._callModel(model, prompt, apiKey);
                return result; 
            } catch (e) {
                console.warn(`Model ${model} gagal:`, e.message);
                lastError = e;
            }
        }
        throw new Error(`Semua model AI gagal. Kesalahan terakhir: ${lastError?.message}`);
    },
    async _callModel(model, prompt, apiKey) {
        const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) {
            let errorMessage = `Kesalahan HTTP ${response.status}`;
            try { const errorBody = await response.json(); if (errorBody.error && errorBody.error.message) errorMessage = errorBody.error.message; } catch (e) { }
            throw new Error(errorMessage);
        }
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
    },
    buildNodeContext: (currentSection, prevSection, nextSection, docMeta, lang) => {
        const targetLang = lang === 'en' ? 'English' : 'Indonesian (Bahasa Indonesia)';
        return `
        KONTEKS DOKUMEN:
        Judul: ${docMeta.title}
        Kategori: ${docMeta.metadata.category}
        Target Audiens: ${docMeta.metadata.target_audience}
        Konteks Bagian Sebelumnya: ${prevSection ? prevSection.content.replace(/<[^>]*>/g, '') : 'Awal dokumen'}
        Konteks Bagian Berikutnya: ${nextSection ? nextSection.content.replace(/<[^>]*>/g, '') : 'Akhir dokumen'}
        Nama Bagian Saat Ini: ${currentSection.sectionKey}
        Isi Saat Ini: ${currentSection.content.replace(/<[^>]*>/g, '')}
        TUGAS:
        Jika isi saat ini kosong, BUAT konten untuk bagian ini.
        Jika sudah ada isi, PERBAIKI dan TINGKATKAN kejelasan, alur, dan nadanya sesuai jenis dokumen.
        BAHASA OUTPUT (PENTING):
        Hasilkan konten sepenuhnya dalam: ${targetLang}.
        BATASAN:
        Kembalikan HANYA tag HTML valid (p, h3, ul, strong). Jangan gunakan markdown. Jangan gunakan pembungkus code block.
        `;
    },
    buildGlobalContext: (sections, docMeta, lang) => {
        const targetLang = lang === 'en' ? 'English' : 'Indonesian (Bahasa Indonesia)';
        const outline = sections.map(s => ({ id: s.id, key: s.sectionKey, isEmpty: s.content.includes('[Write here') || s.content.length < 50, content: s.content }));
        return `
        SYSTEM: Kamu adalah editor akademis dan profesional ahli.
        TUGAS: Tinjau struktur dokumen ini.
        1. Untuk bagian kosong, buat konten berdasarkan kunci bagian dan konteks sekitar.
        2. Untuk bagian yang sudah ada, pertajam bahasanya.
        3. Pertahankan hierarki struktural yang tepat.
        BAHASA OUTPUT (PENTING):
        Semua konten "content" dalam JSON harus ditulis dalam: ${targetLang}.
        DOKUMEN:
        Judul: ${docMeta.title}
        Jenis: ${docMeta.metadata.name}
        DATA INPUT (JSON):
        ${JSON.stringify(outline)}
        FORMAT OUTPUT:
        Kembalikan HANYA array JSON mentah berisi objek dengan field 'id' dan 'content'. 
        Contoh: [{"id": "123", "content": "<h3>...</h3><p>...</p>"}, ...]
        Jangan ubah ID. Jangan hapus node.
        `;
    },
    buildGuidanceContext: (sectionContent, guidanceData, lang) => {
        const targetLang = lang === 'en' ? 'English' : 'Indonesian (Bahasa Indonesia)';
        return `
        ACT AS: Writing coach ahli.
        LANGUAGE: ${targetLang}
        DRAFT USER:
        "${sectionContent.replace(/<[^>]*>/g, '')}"
        TUJUAN BAGIAN INI:
        ${guidanceData.what}
        TUGAS:
        Berikan 3 poin masukan spesifik.
        1. Kekuatan (apa yang sudah baik).
        2. Celah Struktural (apa yang kurang berdasarkan tujuan).
        3. Tips Perbaikan (bagaimana membuatnya lebih baik).
        BATASAN:
        Jangan tuliskan isinya untuk mereka. Tetap singkat (di bawah 100 kata).
        `;
    }
};

/* ═══════════════════════════════════════════════════════════════
   MODULE DATA & CONFIGURATION
   PAK ANGGA, EDIT DI BAWAH INI UNTUK MENAMBAH TEMPLATE
═══════════════════════════════════════════════════════════════ */

const SCHEMA_VERSION = '3.0.0';

// 1. DUMMY DATA (Isi konten contoh - English Only)
const DUMMY_DATA = {
  journal_article: {
    title: 'The Impact of Digital Collaboration Tools',
    sections: [
      { key: 'abstract', content: `<h3>Abstract</h3><p>This study examines the relationship between enterprise digital collaboration tools and knowledge-worker productivity.</p>` },
      { key: 'introduction', content: `<h3>1. Introduction</h3><p>The unprecedented shift to remote work during 2020–2021 compressed a decade of organizational experimentation.</p>` },
      { key: 'framework', content: `<h3>2. Theoretical Framework</h3><p>Our framework synthesizes Media Synchronicity Theory and Cognitive Load Theory.</p>` },
      { key: 'methodology', content: `<h3>3. Methodology</h3><p>A mixed-methods design combining survey (n=412) and interviews (n=24).</p>` },
      { key: 'findings', content: `<h3>4. Findings</h3><p>Tool integration depth was found to be the primary predictor of deep work capacity.</p>` },
      { key: 'discussion', content: `<h3>5. Discussion</h3><p>Results suggest organizations must move beyond tool adoption to tool governance.</p>` },
      { key: 'conclusion', content: `<h3>6. Conclusion</h3><p>We propose a configuration model for remote ecosystems.</p>` }
    ]
  },
  
  /* --- AREA EDIT (PAK ANGGA): TAMBAH DUMMY DATA BARU DI SINI --- */
  /* ID harus sama dengan di Module Registry nanti */
  
  project_proposal: { 
    title: 'Project Alpha: Community Resilience Initiative', 
    sections: [
        { key: 'executive_summary', content: `<h3>Executive Summary</h3><p>This proposal seeks funding to implement a community-based resilience program aimed at urban youth.</p>` },
        { key: 'problem_statement', content: `<h3>1. Problem Statement</h3><p>Current statistics indicate a 15% rise in youth unemployment, leading to decreased community engagement.</p>` },
        { key: 'objectives', content: `<h3>2. Objectives</h3><p>Our primary objective is to train 500 youths in digital literacy within 12 months.</p>` },
        { key: 'implementation_plan', content: `<h3>3. Implementation Plan</h3><p>Phase 1 involves curriculum development (Month 1-2). Phase 2 is recruitment (Month 3).</p>` },
        { key: 'budget', content: `<h3>4. Budget Overview</h3><p>The total requested amount is $50,000, allocated primarily for trainers and equipment.</p>` }
    ] 
  },
    conference_paper: { 
  title: 'Adaptive Attention Mechanisms in Transformer Architectures', 
  sections: [
    { key: 'abstract', content: `<h3>Abstract</h3><p>Recent advances in transformer models have relied on fixed attention patterns. This paper proposes a novel adaptive attention mechanism that dynamically adjusts receptive fields based on input complexity. Experiments on GLUE and SuperGLUE benchmarks show a 2.3% average improvement while reducing FLOPs by 15%.</p>` },
    { key: 'introduction', content: `<h3>1. Introduction</h3><p>The transformer architecture has become ubiquitous in NLP. However, its fixed attention patterns may be suboptimal for varying input lengths and complexities. We introduce AdaAttn, a module that learns to allocate attention spans per layer and head. We demonstrate its effectiveness on multiple tasks.</p>` },
    { key: 'related_work', content: `<h3>2. Related Work</h3><p>Previous work has explored sparse attention (Child et al., 2019) and adaptive computation time (Graves, 2016). Our work differs by making attention span a learnable parameter conditioned on input.</p>` },
    { key: 'method', content: `<h3>3. Method</h3><p>We augment each attention head with a learnable gate that controls the effective context size. The gate is a sigmoid over a learned embedding. The model is trained end-to-end with the standard cross-entropy loss.</p>` },
    { key: 'experiments', content: `<h3>4. Experiments</h3><p>We evaluate on GLUE (Wang et al., 2018) and SuperGLUE. We compare against BERT-base and RoBERTa-base. Results show AdaAttn outperforms baselines on 7 out of 11 tasks.</p>` },
    { key: 'conclusion', content: `<h3>5. Conclusion</h3><p>We presented an adaptive attention mechanism that improves efficiency and performance. Future work includes applying it to long-document tasks.</p>` }
  ] 
},
research_report: { 
  title: 'Urban Mobility Transitions in Post-Pandemic Cities', 
  sections: [
    { key: 'executive_summary', content: `<h3>Executive Summary</h3><p>This report examines shifts in urban mobility patterns following the COVID-19 pandemic. Using data from 12 global cities, we identify a sustained increase in cycling and micro-mobility usage, and a decline in public transit ridership. Recommendations for urban planners are provided.</p>` },
    { key: 'background', content: `<h3>1. Background</h3><p>The pandemic accelerated changes in how people move. Lockdowns led to a temporary drop in all travel, but as economies reopen, modal splits have shifted. This study investigates whether these changes are temporary or permanent.</p>` },
    { key: 'methodology', content: `<h3>2. Methodology</h3><p>We collected anonymized mobile phone data, public transport usage statistics, and cycling counts from 12 cities across North America, Europe, and Asia. Data spans 2019–2023. We applied interrupted time series analysis.</p>` },
    { key: 'findings', content: `<h3>3. Findings</h3><p>Cycling increased by an average of 42% compared to pre-pandemic levels. Public transit ridership remains 25% below 2019 levels. Car usage has returned to near pre-pandemic levels. Significant variation exists between cities.</p>` },
    { key: 'recommendations', content: `<h3>4. Recommendations</h3><p>Cities should invest in protected cycling infrastructure, reconsider road space allocation, and explore integrated mobility-as-a-service platforms to boost public transit.</p>` }
  ] 
},
working_paper: { 
  title: 'Generative AI and Labor Market Dynamics: A Preliminary Analysis', 
  sections: [
    { key: 'abstract', content: `<h3>Abstract</h3><p>This working paper explores the early impact of generative AI on employment across sectors. Using job posting data from 2022–2024, we find that occupations involving writing and coding are experiencing significant shifts, with a 12% decline in entry-level postings. We discuss implications for workforce development.</p>` },
    { key: 'introduction', content: `<h3>1. Introduction</h3><p>The rapid adoption of generative AI tools like ChatGPT has raised concerns about job displacement. This paper provides preliminary evidence on how firms are adjusting their hiring.</p>` },
    { key: 'literature_review', content: `<h3>2. Literature Review</h3><p>Previous studies on automation (Acemoglu & Restrepo, 2020) have focused on routine tasks. Generative AI targets non-routine cognitive tasks, suggesting a new wave of automation.</p>` },
    { key: 'theoretical_framework', content: `<h3>3. Theoretical Framework</h3><p>We draw on task-based models of labor demand, where AI substitutes for certain tasks and complements others.</p>` },
    { key: 'preliminary_analysis', content: `<h3>4. Preliminary Analysis</h3><p>Using Burning Glass Technologies data, we analyze job postings in 10 occupational groups. We find significant declines in writing-intensive roles, but increases in AI-related roles.</p>` },
    { key: 'discussion', content: `<h3>5. Discussion</h3><p>These early trends suggest a need for reskilling programs and updated labor market policies.</p>` },
    { key: 'conclusion', content: `<h3>6. Conclusion</h3><p>Ongoing research will refine these estimates and explore heterogeneity by firm size and industry.</p>` }
  ] 
},
dissertation_thesis: { 
  title: 'Essays on the Economics of Digital Platforms', 
  sections: [
    { key: 'abstract', content: `<h3>Abstract</h3><p>This dissertation comprises three essays examining the economic effects of digital platforms. The first essay studies market power in app stores. The second analyzes labor supply on gig platforms. The third investigates algorithmic pricing and collusion. Using a combination of structural models and reduced-form methods, I find significant welfare implications for consumers and workers.</p>` },
    { key: 'introduction', content: `<h3>1. Introduction</h3><p>Digital platforms have transformed markets, but their economic impacts are not fully understood. This dissertation aims to fill that gap.</p>` },
    { key: 'literature_review', content: `<h3>2. Literature Review</h3><p>I review the literature on two-sided markets, platform governance, and gig economy.</p>` },
    { key: 'methodology', content: `<h3>3. Methodology</h3><p>Essay 1 uses a differentiated products demand model. Essay 2 applies dynamic panel data methods. Essay 3 uses algorithmic collusion simulations.</p>` },
    { key: 'findings', content: `<h3>4. Findings</h3><p>I find that app store fees lead to higher consumer prices; gig workers face significant earnings volatility; and algorithmic pricing can sustain collusion without communication.</p>` },
    { key: 'discussion', content: `<h3>5. Discussion</h3><p>The results have implications for antitrust policy and labor regulation.</p>` },
    { key: 'conclusion', content: `<h3>6. Conclusion</h3><p>Future work should explore platform design interventions.</p>` },
    { key: 'references', content: `<h3>References</h3><p>[1] Rochet, J.-C., & Tirole, J. (2003). Platform competition...<br>[2] etc.</p>` }
  ] 
},
policy_brief: { 
  title: 'Expanding Access to Early Childhood Education', 
  sections: [
    { key: 'executive_summary', content: `<h3>Executive Summary</h3><p>Only 60% of low-income children have access to pre-K programs. This brief recommends a federal-state partnership to fund universal pre-K, estimating a net economic benefit of $8,000 per child over their lifetime.</p>` },
    { key: 'key_recommendations', content: `<h3>Key Recommendations</h3><ul><li>Increase federal matching funds for state pre-K programs.</li><li>Establish quality standards and training requirements.</li><li>Integrate with existing childcare subsidies.</li></ul>` },
    { key: 'context', content: `<h3>Context</h3><p>Research shows that early childhood education yields high returns, yet access remains unequal.</p>` },
    { key: 'evidence', content: `<h3>Evidence</h3><p>Studies from Chicago and Boston show participants have higher graduation rates and earnings. Cost-benefit analyses suggest a benefit-cost ratio of 7:1.</p>` },
    { key: 'implications', content: `<h3>Implications</h3><p>Universal pre-K could reduce achievement gaps and boost long-term productivity.</p>` },
    { key: 'conclusion', content: `<h3>Conclusion</h3><p>Policymakers should act now to expand access.</p>` }
  ] 
},
policy_paper: { 
  title: 'Reforming the Renewable Energy Subsidy Framework', 
  sections: [
    { key: 'executive_summary', content: `<h3>Executive Summary</h3><p>Current renewable energy subsidies are inefficient and regressive. This paper analyzes three reform options: a carbon tax with rebate, a clean energy standard, and technology-neutral auctions. We recommend a phased transition to technology-neutral auctions combined with a carbon price floor.</p>` },
    { key: 'problem_definition', content: `<h3>1. Problem Definition</h3><p>Subsidies vary widely by technology, leading to market distortions and high costs to consumers.</p>` },
    { key: 'policy_options', content: `<h3>2. Policy Options</h3><p>Option A: Carbon tax with revenue recycling. Option B: Clean energy standard. Option C: Technology-neutral auctions.</p>` },
    { key: 'analysis', content: `<h3>3. Analysis</h3><p>We evaluate each option on cost-effectiveness, equity, and political feasibility. Auctions score highest on cost but require careful design.</p>` },
    { key: 'recommendations', content: `<h3>4. Recommendations</h3><p>Implement auctions for all new renewable capacity, with set-asides for emerging technologies. Phase out production tax credits over five years.</p>` },
    { key: 'implementation', content: `<h3>5. Implementation</h3><p>Create an independent agency to run auctions. Coordinate with states.</p>` }
  ] 
},
white_paper: { 
  title: 'Zero-Trust Architecture for Cloud Security', 
  sections: [
    { key: 'executive_summary', content: `<h3>Executive Summary</h3><p>As organizations migrate to the cloud, traditional perimeter-based security is inadequate. Zero-trust architecture (ZTA) assumes no implicit trust and verifies every access request. This white paper outlines a framework for implementing ZTA, including key components and deployment roadmap.</p>` },
    { key: 'introduction', content: `<h3>1. Introduction</h3><p>The rise of remote work and cloud services has blurred network perimeters. ZTA offers a more robust security model.</p>` },
    { key: 'current_challenges', content: `<h3>2. Current Challenges</h3><p>VPN vulnerabilities, insider threats, and complex identity management.</p>` },
    { key: 'proposed_solution', content: `<h3>3. Proposed Solution</h3><p>Implement ZTA using micro-segmentation, continuous monitoring, and identity-aware proxies.</p>` },
    { key: 'benefits', content: `<h3>4. Benefits</h3><p>Reduced attack surface, improved compliance, and better user experience.</p>` },
    { key: 'roadmap', content: `<h3>5. Roadmap</h3><p>Phase 1: Inventory and classify assets. Phase 2: Deploy identity and access management. Phase 3: Implement micro-segmentation. Phase 4: Continuous monitoring and analytics.</p>` },
    { key: 'conclusion', content: `<h3>6. Conclusion</h3><p>ZTA is essential for modern cloud security. Organizations should start now.</p>` }
  ] 
},
position_paper: { 
  title: 'Position on Data Localization Requirements', 
  sections: [
    { key: 'executive_summary', content: `<h3>Executive Summary</h3><p>This paper presents the Chamber of Commerce's position on data localization laws. While we recognize data privacy concerns, we argue that mandatory data localization harms trade, increases costs, and does not necessarily improve security. We advocate for interoperability frameworks and cross-border data flows with strong privacy safeguards.</p>` },
    { key: 'introduction', content: `<h3>1. Introduction</h3><p>Several countries have introduced data localization requirements. This paper examines their impact.</p>` },
    { key: 'stance', content: `<h3>2. Stance</h3><p>We oppose mandatory data localization. Instead, we support mutual recognition of privacy regimes.</p>` },
    { key: 'arguments', content: `<h3>3. Arguments</h3><p>Localization raises costs for SMEs, fragments the internet, and can lead to trade retaliation.</p>` },
    { key: 'counterarguments', content: `<h3>4. Counterarguments</h3><p>Proponents argue localization protects privacy and national security. However, existing privacy laws like GDPR already provide strong protections without localization.</p>` },
    { key: 'conclusion', content: `<h3>5. Conclusion</h3><p>We urge policymakers to reject data localization and pursue international agreements on data flows.</p>` }
  ] 
},
technical_report: { 
  title: 'Performance Evaluation of LoRaWAN in Urban Environments', 
  sections: [
    { key: 'abstract', content: `<h3>Abstract</h3><p>This technical report evaluates the performance of LoRaWAN networks in dense urban settings. We deployed 20 gateways and 500 end devices across a 10 km² area. Results show a packet delivery ratio of 92% for distances up to 2 km, but significant interference in high-rise zones. Recommendations for network planning are provided.</p>` },
    { key: 'introduction', content: `<h3>1. Introduction</h3><p>LoRaWAN is a popular LPWAN technology, but its performance in urban canyons is not well documented.</p>` },
    { key: 'system_overview', content: `<h3>2. System Overview</h3><p>We used Multitech gateways and various end devices. The network operates at 868 MHz.</p>` },
    { key: 'methodology', content: `<h3>3. Methodology</h3><p>We measured RSSI, SNR, and packet loss at multiple locations. Data was collected over 30 days.</p>` },
    { key: 'results', content: `<h3>4. Results</h3><p>Average RSSI: -95 dBm; SNR: 6 dB; packet delivery ratio: 92% line-of-sight, 78% non-line-of-sight.</p>` },
    { key: 'discussion', content: `<h3>5. Discussion</h3><p>Interference from other devices and multipath fading are major issues. Increasing gateway density can mitigate.</p>` },
    { key: 'conclusion', content: `<h3>6. Conclusion</h3><p>LoRaWAN is viable for urban IoT but requires careful planning.</p>` }
  ] 
},
guideline_sop: { 
  title: 'Standard Operating Procedure for Clinical Trial Data Management', 
  sections: [
    { key: 'purpose', content: `<h3>1. Purpose</h3><p>This SOP defines the procedures for data collection, entry, validation, and storage in clinical trials to ensure compliance with GCP guidelines.</p>` },
    { key: 'scope', content: `<h3>2. Scope</h3><p>Applies to all clinical trial staff involved in data management.</p>` },
    { key: 'definitions', content: `<h3>3. Definitions</h3><p>CRF: Case Report Form; eCRF: electronic Case Report Form; Query: request for clarification.</p>` },
    { key: 'responsibilities', content: `<h3>4. Responsibilities</h3><p>Data Manager: oversees data entry and validation. CRA: monitors data quality. Investigator: ensures accuracy.</p>` },
    { key: 'procedure', content: `<h3>5. Procedure</h3><ol><li>Data entry within 5 days of visit.</li><li>Automated validation checks.</li><li>Query resolution within 3 days.</li><li>Database lock after final monitoring visit.</li></ol>` },
    { key: 'compliance', content: `<h3>6. Compliance</h3><p>Non-compliance will be reported to QA and may result in corrective action.</p>` },
    { key: 'references', content: `<h3>7. References</h3><p>ICH GCP E6(R2); 21 CFR Part 11.</p>` }
  ] 
},
regulatory_impact_assessment: { 
  title: 'RIA of Proposed Fuel Economy Standards for Light-Duty Vehicles', 
  sections: [
    { key: 'executive_summary', content: `<h3>Executive Summary</h3><p>This RIA assesses the proposed rule to increase average fuel economy to 55 mpg by 2026. Benefits include reduced greenhouse gas emissions and fuel savings, while costs include higher vehicle prices. Net benefits are estimated at $150 billion over 30 years.</p>` },
    { key: 'problem_identification', content: `<h3>1. Problem Identification</h3><p>Transportation accounts for 29% of U.S. GHG emissions. Current standards are insufficient to meet climate goals.</p>` },
    { key: 'objectives', content: `<h3>2. Objectives</h3><p>Reduce emissions, reduce oil dependence, and provide consumer savings.</p>` },
    { key: 'options', content: `<h3>3. Options</h3><p>Option 1: No action. Option 2: 50 mpg by 2026. Option 3: 55 mpg by 2026 (preferred). Option 4: 60 mpg by 2026.</p>` },
    { key: 'impact_analysis', content: `<h3>4. Impact Analysis</h3><p>Option 3 yields the highest net benefits. Costs: +$1,500 per vehicle. Benefits: $4,000 fuel savings per vehicle over lifetime, 200 Mt CO2 reduction.</p>` },
    { key: 'consultation', content: `<h3>5. Consultation</h3><p>Stakeholder comments from automakers, environmental groups, and consumers were considered.</p>` },
    { key: 'recommendation', content: `<h3>6. Recommendation</h3><p>Adopt Option 3 with a phased implementation.</p>` }
  ] 
},;
      /* ------------------------------------------------------------- */

// 2. GUIDANCE ENGINE (Panduan Bilingual - EN & ID)
const GUIDANCE = {
  journal_article: {
    _analogy: { en: 'A journal article is a courtroom argument.', id: 'Artikel jurnal ibarat argumen di pengadilan.' },
    abstract: {
      en: { what: 'Self-contained summary of the entire paper.', tip: 'Think of it as a movie trailer.' },
      id: { what: 'Ringkasan mandiri seluruh makalah.', tip: 'Bayangkan seperti trailer film.' }
    }
  },

  /* --- AREA EDIT (PAK ANGGA): TAMBAH GUIDANCE BARU DI SINI --- */
  
  project_proposal: {
    _analogy: { en: 'A proposal is a sales pitch.', id: 'Proposal adalah presentasi penjualan (pitching).' },
    executive_summary: {
      en: { what: 'Hook the funder immediately. Summarize the need and the solution.', tip: 'Write this last.' },
      id: { what: 'Pikat pemberi dana segera. Rangkum kebutuhan dan solusinya.', tip: 'Tulis bagian ini terakhir.' }
    },
    problem_statement: {
      en: { what: 'Define the gap or pain point using data.', tip: 'Use statistics to prove urgency.' },
      id: { what: 'Definisikan kesenjangan atau masalah menggunakan data.', tip: 'Gunakan statistik untuk membuktikan urgensi.' }
    },
    objectives: {
      en: { what: 'Specific, Measurable, Achievable goals.', tip: 'Use SMART criteria.' },
      id: { what: 'Tujuan yang Spesifik, Terukur, Dapat Dicapai.', tip: 'Gunakan kriteria SMART.' }
    },
    implementation_plan: {
      en: { what: 'The step-by-step roadmap.', tip: 'Be realistic with timelines.' },
      id: { what: 'Peta jalan langkah demi langkah.', tip: 'Bersikaplah realistis dengan jadwal waktu.' }
    },
    budget: {
      en: { what: 'Justification of costs.', tip: 'Ensure every dollar aligns with an objective.' },
      id: { what: 'Justifikasi biaya.', tip: 'Pastikan setiap Rupiah selaras dengan tujuan.' }
    }
  }, conference_paper: {
  _analogy: { en: 'A conference paper is a snapshot of ongoing research.', id: 'Makalah konferensi adalah cuplikan penelitian yang sedang berlangsung.' },
  abstract: {
    en: { what: 'Summarize the problem, method, key result, and implication.', tip: 'Make it self-contained; readers decide to attend based on this.' },
    id: { what: 'Ringkas masalah, metode, hasil utama, dan implikasi.', tip: 'Buatlah mandiri; pembaca memutuskan untuk hadir berdasarkan ini.' }
  },
  introduction: {
    en: { what: 'State the research question, motivation, and contribution.', tip: 'End with a clear outline of the paper.' },
    id: { what: 'Nyatakan pertanyaan penelitian, motivasi, dan kontribusi.', tip: 'Akhiri dengan garis besar makalah yang jelas.' }
  },
  related_work: {
    en: { what: 'Situate your work among existing literature.', tip: 'Highlight the gap you are filling.' },
    id: { what: 'Letakkan karya Anda di antara literatur yang ada.', tip: 'Soroti celah yang Anda isi.' }
  },
  method: {
    en: { what: 'Describe your approach, data, and experimental setup.', tip: 'Provide enough detail for reproducibility.' },
    id: { what: 'Jelaskan pendekatan, data, dan pengaturan eksperimen Anda.', tip: 'Berikan detail yang cukup untuk reproduksibilitas.' }
  },
  experiments: {
    en: { what: 'Present results, comparisons, and ablation studies.', tip: 'Use tables/figures to summarize.' },
    id: { what: 'Sajikan hasil, perbandingan, dan studi ablasi.', tip: 'Gunakan tabel/figur untuk meringkas.' }
  },
  conclusion: {
    en: { what: 'Summarize findings and future work.', tip: 'Do not introduce new results.' },
    id: { what: 'Ringkas temuan dan penelitian selanjutnya.', tip: 'Jangan memperkenalkan hasil baru.' }
  }
},
research_report: {
  _analogy: { en: 'A research report is a briefing for decision-makers.', id: 'Laporan penelitian adalah briefing untuk pengambil keputusan.' },
  executive_summary: {
    en: { what: 'Summarize the entire report: problem, methods, key findings, recommendations.', tip: 'Write last; keep to one page.' },
    id: { what: 'Ringkas seluruh laporan: masalah, metode, temuan utama, rekomendasi.', tip: 'Tulis terakhir; tetap dalam satu halaman.' }
  },
  background: {
    en: { what: 'Provide context, why the research was commissioned.', tip: 'Include relevant statistics.' },
    id: { what: 'Berikan konteks, mengapa penelitian ini dipesan.', tip: 'Sertakan statistik yang relevan.' }
  },
  methodology: {
    en: { what: 'Explain data sources, collection methods, and analysis.', tip: 'Be transparent about limitations.' },
    id: { what: 'Jelaskan sumber data, metode pengumpulan, dan analisis.', tip: 'Bersikaplah transparan tentang keterbatasan.' }
  },
  findings: {
    en: { what: 'Present the evidence without interpretation.', tip: 'Use bullet points for clarity.' },
    id: { what: 'Sajikan bukti tanpa interpretasi.', tip: 'Gunakan poin-poin untuk kejelasan.' }
  },
  recommendations: {
    en: { what: 'List actionable steps based on findings.', tip: 'Prioritize by impact/feasibility.' },
    id: { what: 'Daftar langkah-langkah yang dapat ditindaklanjuti berdasarkan temuan.', tip: 'Prioritaskan berdasarkan dampak/kelayakan.' }
  }
},

// === PANDUAN UNTUK TEMPLATE BARU ===
working_paper: {
  _analogy: { en: 'A working paper is a work in progress, open for feedback.', id: 'Working paper adalah karya yang sedang berjalan, terbuka untuk masukan.' },
  abstract: {
    en: { what: 'State the research question, preliminary findings, and contribution.', tip: 'Emphasize novelty.' },
    id: { what: 'Nyatakan pertanyaan penelitian, temuan awal, dan kontribusi.', tip: 'Tekankan kebaruan.' }
  },
  introduction: {
    en: { what: 'Introduce the problem and why it matters now.', tip: 'Cite recent developments.' },
    id: { what: 'Perkenalkan masalah dan mengapa penting saat ini.', tip: 'Kutip perkembangan terbaru.' }
  },
  literature_review: {
    en: { what: 'Discuss relevant prior work and identify gaps.', tip: 'Focus on literature from the last 5 years.' },
    id: { what: 'Bahas karya sebelumnya yang relevan dan identifikasi celah.', tip: 'Fokus pada literatur 5 tahun terakhir.' }
  },
  theoretical_framework: {
    en: { what: 'Outline the concepts or models guiding your analysis.', tip: 'Keep it concise; elaborate in later versions.' },
    id: { what: 'Gariskan konsep atau model yang memandu analisis Anda.', tip: 'Tetap ringkas; akan diperluas di versi selanjutnya.' }
  },
  preliminary_analysis: {
    en: { what: 'Present early data or stylized facts.', tip: 'Acknowledge limitations.' },
    id: { what: 'Sajikan data awal atau fakta bergaya.', tip: 'Akui keterbatasan.' }
  },
  discussion: {
    en: { what: 'Interpret findings and link to literature.', tip: 'Suggest implications.' },
    id: { what: 'Interpretasikan temuan dan hubungkan dengan literatur.', tip: 'Sarankan implikasi.' }
  },
  conclusion: {
    en: { what: 'Summarize and outline next steps.', tip: 'Invite feedback.' },
    id: { what: 'Ringkas dan gariskan langkah selanjutnya.', tip: 'Undang masukan.' }
  }
},
dissertation_thesis: {
  _analogy: { en: 'A thesis is your contribution to a scholarly conversation.', id: 'Tesis adalah kontribusi Anda dalam percakapan ilmiah.' },
  abstract: {
    en: { what: 'Summarize each essay/chapter, overall contribution.', tip: 'Write after completing the dissertation.' },
    id: { what: 'Ringkas setiap esai/bab, kontribusi keseluruhan.', tip: 'Tulis setelah menyelesaikan disertasi.' }
  },
  introduction: {
    en: { what: 'Present the overarching research question and why it matters.', tip: 'Outline the structure.' },
    id: { what: 'Sajikan pertanyaan penelitian utama dan mengapa penting.', tip: 'Gariskan struktur.' }
  },
  literature_review: {
    en: { what: 'Synthesize literature that frames all essays.', tip: 'Identify the gap your thesis fills.' },
    id: { what: 'Sintesis literatur yang membingkai semua esai.', tip: 'Identifikasi celah yang diisi tesis Anda.' }
  },
  methodology: {
    en: { what: 'Describe methods used across essays (if common).', tip: 'Justify choices.' },
    id: { what: 'Jelaskan metode yang digunakan di semua esai (jika umum).', tip: 'Justifikasi pilihan.' }
  },
  findings: {
    en: { what: 'Present key results from each essay.', tip: 'Use subheadings per essay.' },
    id: { what: 'Sajikan hasil utama dari setiap esai.', tip: 'Gunakan subjudul per esai.' }
  },
  discussion: {
    en: { what: 'Integrate findings, discuss implications, limitations.', tip: 'Connect back to literature.' },
    id: { what: 'Integrasikan temuan, bahas implikasi, keterbatasan.', tip: 'Hubungkan kembali ke literatur.' }
  },
  conclusion: {
    en: { what: 'Summarize contributions and future research.', tip: 'End with a strong takeaway.' },
    id: { what: 'Ringkas kontribusi dan penelitian selanjutnya.', tip: 'Akhiri dengan pesan kuat.' }
  },
  references: {
    en: { what: 'List all cited works in consistent style.', tip: 'Use reference manager.' },
    id: { what: 'Daftar semua karya yang dikutip dengan gaya konsisten.', tip: 'Gunakan manajer referensi.' }
  }
},
policy_brief: {
  _analogy: { en: 'A policy brief is a call to action for busy policymakers.', id: 'Policy brief adalah ajakan bertindak untuk pembuat kebijakan yang sibuk.' },
  executive_summary: {
    en: { what: 'State the problem, key recommendation, and main evidence.', tip: 'One paragraph max.' },
    id: { what: 'Nyatakan masalah, rekomendasi utama, dan bukti utama.', tip: 'Maksimal satu paragraf.' }
  },
  key_recommendations: {
    en: { what: 'List 3–5 actionable recommendations.', tip: 'Make them specific and feasible.' },
    id: { what: 'Daftar 3–5 rekomendasi yang dapat ditindaklanjuti.', tip: 'Buatlah spesifik dan layak.' }
  },
  context: {
    en: { what: 'Briefly describe the policy issue and its importance.', tip: 'Use a hook to grab attention.' },
    id: { what: 'Jelaskan secara singkat masalah kebijakan dan pentingnya.', tip: 'Gunakan kalimat pembuka yang menarik.' }
  },
  evidence: {
    en: { what: 'Present data, research, or case studies supporting your recommendations.', tip: 'Highlight 2–3 key facts.' },
    id: { what: 'Sajikan data, penelitian, atau studi kasus yang mendukung rekomendasi Anda.', tip: 'Sorot 2–3 fakta kunci.' }
  },
  implications: {
    en: { what: 'Discuss costs, benefits, and trade-offs.', tip: 'Be honest about uncertainties.' },
    id: { what: 'Bahas biaya, manfaat, dan trade-off.', tip: 'Jujurlah tentang ketidakpastian.' }
  },
  conclusion: {
    en: { what: 'Reiterate the call to action.', tip: 'Keep it short.' },
    id: { what: 'Ulangi ajakan bertindak.', tip: 'Tetap singkat.' }
  }
},
policy_paper: {
  _analogy: { en: 'A policy paper is a deep dive into options.', id: 'Policy paper adalah analisis mendalam tentang pilihan-pilihan.' },
  executive_summary: {
    en: { what: 'Summarize the problem, options analyzed, and recommended course.', tip: 'Include key numbers.' },
    id: { what: 'Ringkas masalah, opsi yang dianalisis, dan arah yang direkomendasikan.', tip: 'Sertakan angka-angka kunci.' }
  },
  problem_definition: {
    en: { what: 'Define the issue with evidence.', tip: 'Use data to show magnitude.' },
    id: { what: 'Definisikan masalah dengan bukti.', tip: 'Gunakan data untuk menunjukkan besaran.' }
  },
  policy_options: {
    en: { what: 'Describe each option clearly.', tip: 'Include a “no action” baseline.' },
    id: { what: 'Jelaskan setiap opsi dengan jelas.', tip: 'Sertakan opsi “tanpa tindakan” sebagai dasar.' }
  },
  analysis: {
    en: { what: 'Evaluate options against criteria (cost, effectiveness, equity, feasibility).', tip: 'Use a comparison matrix.' },
    id: { what: 'Evaluasi opsi berdasarkan kriteria (biaya, efektivitas, kesetaraan, kelayakan).', tip: 'Gunakan matriks perbandingan.' }
  },
  recommendations: {
    en: { what: 'State your preferred option and justify.', tip: 'Address implementation challenges.' },
    id: { what: 'Nyatakan opsi pilihan Anda dan beri justifikasi.', tip: 'Bahasa tantangan implementasi.' }
  },
  implementation: {
    en: { what: 'Outline steps, timeline, and responsible actors.', tip: 'Mention monitoring mechanisms.' },
    id: { what: 'Gariskan langkah, jadwal, dan aktor yang bertanggung jawab.', tip: 'Sebutkan mekanisme pemantauan.' }
  }
},
white_paper: {
  _analogy: { en: 'A white paper is a persuasive technical brief.', id: 'White paper adalah brief teknis yang persuasif.' },
  executive_summary: {
    en: { what: 'Summarize the problem, solution, and benefits.', tip: 'Target C-level readers.' },
    id: { what: 'Ringkas masalah, solusi, dan manfaat.', tip: 'Targetkan pembaca tingkat direksi.' }
  },
  introduction: {
    en: { what: 'Set the stage: why this issue matters now.', tip: 'Use a compelling statistic.' },
    id: { what: 'Atur panggung: mengapa masalah ini penting saat ini.', tip: 'Gunakan statistik yang menarik.' }
  },
  current_challenges: {
    en: { what: 'Describe pain points and limitations of existing approaches.', tip: 'Be specific with examples.' },
    id: { what: 'Jelaskan masalah dan keterbatasan pendekatan yang ada.', tip: 'Berikan contoh spesifik.' }
  },
  proposed_solution: {
    en: { what: 'Explain your solution, how it works, and its uniqueness.', tip: 'Use diagrams if possible (describe).' },
    id: { what: 'Jelaskan solusi Anda, cara kerjanya, dan keunikannya.', tip: 'Gunakan diagram jika memungkinkan (deskripsikan).' }
  },
  benefits: {
    en: { what: 'Quantify advantages: ROI, efficiency, security.', tip: 'Compare to alternatives.' },
    id: { what: 'Kuantifikasi keuntungan: ROI, efisiensi, keamanan.', tip: 'Bandingkan dengan alternatif.' }
  },
  roadmap: {
    en: { what: 'Outline implementation phases and timeline.', tip: 'Be realistic.' },
    id: { what: 'Gariskan fase implementasi dan jadwal.', tip: 'Bersikaplah realistis.' }
  },
  conclusion: {
    en: { what: 'Reinforce the call to adopt the solution.', tip: 'End with contact/next steps.' },
    id: { what: 'Perkuat ajakan untuk mengadopsi solusi.', tip: 'Akhiri dengan kontak/langkah selanjutnya.' }
  }
},
position_paper: {
  _analogy: { en: 'A position paper states where you stand.', id: 'Position paper menyatakan posisi Anda.' },
  executive_summary: {
    en: { what: 'State your position and main arguments.', tip: 'One paragraph.' },
    id: { what: 'Nyatakan posisi Anda dan argumen utama.', tip: 'Satu paragraf.' }
  },
  introduction: {
    en: { what: 'Introduce the issue and why it’s contested.', tip: 'Brief background.' },
    id: { what: 'Perkenalkan isu dan mengapa diperdebatkan.', tip: 'Latar belakang singkat.' }
  },
  stance: {
    en: { what: 'Clearly articulate your position.', tip: 'Use a strong thesis statement.' },
    id: { what: 'Artikulasikan posisi Anda dengan jelas.', tip: 'Gunakan pernyataan tesis yang kuat.' }
  },
  arguments: {
    en: { what: 'Present supporting evidence and reasoning.', tip: 'Address each argument separately.' },
    id: { what: 'Sajikan bukti dan alasan pendukung.', tip: 'Tangani setiap argumen secara terpisah.' }
  },
  counterarguments: {
    en: { what: 'Acknowledge opposing views and rebut them.', tip: 'Show fairness and strength.' },
    id: { what: 'Akui pandangan yang berlawanan dan bantah.', tip: 'Tunjukkan keadilan dan kekuatan.' }
  },
  conclusion: {
    en: { what: 'Summarize and call for action.', tip: 'Reiterate the stakes.' },
    id: { what: 'Ringkas dan ajak bertindak.', tip: 'Ulangi apa yang dipertaruhkan.' }
  }
},
technical_report: {
  _analogy: { en: 'A technical report is a lab notebook for others.', id: 'Laporan teknis adalah catatan laboratorium untuk orang lain.' },
  abstract: {
    en: { what: 'Summarize objectives, methods, key results, and conclusions.', tip: 'Include numerical highlights.' },
    id: { what: 'Ringkas tujuan, metode, hasil utama, dan kesimpulan.', tip: 'Sertakan sorotan numerik.' }
  },
  introduction: {
    en: { what: 'State the problem and context.', tip: 'Mention who commissioned it.' },
    id: { what: 'Nyatakan masalah dan konteks.', tip: 'Sebutkan siapa yang memesannya.' }
  },
  system_overview: {
    en: { what: 'Describe the hardware/software/system under test.', tip: 'Include specifications.' },
    id: { what: 'Jelaskan perangkat keras/perangkat lunak/sistem yang diuji.', tip: 'Sertakan spesifikasi.' }
  },
  methodology: {
    en: { what: 'Detail test setup, procedures, and measurement tools.', tip: 'Include calibration info.' },
    id: { what: 'Rinci pengaturan uji, prosedur, dan alat ukur.', tip: 'Sertakan info kalibrasi.' }
  },
  results: {
    en: { what: 'Present data in tables/figures with brief descriptions.', tip: 'Do not interpret yet.' },
    id: { what: 'Sajikan data dalam tabel/figur dengan deskripsi singkat.', tip: 'Jangan interpretasi dulu.' }
  },
  discussion: {
    en: { what: 'Interpret results, compare to expectations, note anomalies.', tip: 'Suggest improvements.' },
    id: { what: 'Interpretasi hasil, bandingkan dengan harapan, catat anomali.', tip: 'Sarankan perbaikan.' }
  },
  conclusion: {
    en: { what: 'Summarize main takeaways.', tip: 'Mention if further testing is needed.' },
    id: { what: 'Ringkas kesimpulan utama.', tip: 'Sebutkan jika diperlukan pengujian lebih lanjut.' }
  }
},
guideline_sop: {
  _analogy: { en: 'An SOP is a recipe for consistency.', id: 'SOP adalah resep untuk konsistensi.' },
  purpose: {
    en: { what: 'Explain why the SOP exists.', tip: 'Link to regulations if applicable.' },
    id: { what: 'Jelaskan mengapa SOP ini ada.', tip: 'Hubungkan dengan regulasi jika ada.' }
  },
  scope: {
    en: { what: 'Define who and what the SOP covers.', tip: 'Mention exclusions.' },
    id: { what: 'Tentukan siapa dan apa yang dicakup SOP.', tip: 'Sebutkan pengecualian.' }
  },
  definitions: {
    en: { what: 'Define key terms and acronyms.', tip: 'Keep it simple.' },
    id: { what: 'Definisikan istilah dan akronim kunci.', tip: 'Tetap sederhana.' }
  },
  responsibilities: {
    en: { what: 'List roles and their duties.', tip: 'Use a table if many.' },
    id: { what: 'Daftar peran dan tugas mereka.', tip: 'Gunakan tabel jika banyak.' }
  },
  procedure: {
    en: { what: 'Provide step-by-step instructions.', tip: 'Use numbered steps, active voice.' },
    id: { what: 'Berikan instruksi langkah demi langkah.', tip: 'Gunakan langkah bernomor, kalimat aktif.' }
  },
  compliance: {
    en: { what: 'Explain consequences of non-compliance.', tip: 'Reference related policies.' },
    id: { what: 'Jelaskan konsekuensi ketidakpatuhan.', tip: 'Rujuk kebijakan terkait.' }
  },
  references: {
    en: { what: 'List related documents and regulations.', tip: 'Include version numbers.' },
    id: { what: 'Daftar dokumen dan regulasi terkait.', tip: 'Sertakan nomor versi.' }
  }
},
regulatory_impact_assessment: {
  _analogy: { en: 'An RIA is a cost–benefit analysis for rules.', id: 'RIA adalah analisis biaya-manfaat untuk peraturan.' },
  executive_summary: {
    en: { what: 'Summarize the problem, preferred option, and net benefits.', tip: 'Highlight key numbers.' },
    id: { what: 'Ringkas masalah, opsi yang dipilih, dan manfaat bersih.', tip: 'Sorot angka-angka kunci.' }
  },
  problem_identification: {
    en: { what: 'Describe the market failure or issue.', tip: 'Use evidence.' },
    id: { what: 'Jelaskan kegagalan pasar atau masalah.', tip: 'Gunakan bukti.' }
  },
  objectives: {
    en: { what: 'State what the regulation aims to achieve.', tip: 'Be specific and measurable.' },
    id: { what: 'Nyatakan apa yang ingin dicapai oleh regulasi.', tip: 'Spesifik dan terukur.' }
  },
  options: {
    en: { what: 'List alternative approaches, including “do nothing”.', tip: 'Describe each concisely.' },
    id: { what: 'Daftar pendekatan alternatif, termasuk “tidak melakukan apa pun”.', tip: 'Jelaskan masing-masing secara ringkas.' }
  },
  impact_analysis: {
    en: { what: 'Quantify costs, benefits, and distributional effects.', tip: 'Use monetized values where possible.' },
    id: { what: 'Kuantifikasi biaya, manfaat, dan efek distribusi.', tip: 'Gunakan nilai moneter jika memungkinkan.' }
  },
  consultation: {
    en: { what: 'Summarize stakeholder feedback and how it influenced the analysis.', tip: 'Be transparent.' },
    id: { what: 'Ringkas masukan pemangku kepentingan dan bagaimana pengaruhnya terhadap analisis.', tip: 'Bersikaplah transparan.' }
  },
  recommendation: {
    en: { what: 'State the preferred option and justification.', tip: 'Mention next steps.' },
    id: { what: 'Nyatakan opsi yang dipilih dan justifikasi.', tip: 'Sebutkan langkah selanjutnya.' }
  }
}

  /* ------------------------------------------------------------- */
};

const CATEGORY_CONFIG = {
  academic: { label: 'Academic', color: 'blue', icon: <GraduationCap className="w-5 h-5" />, logic: 'IMRaD' },
  policy: { label: 'Policy', color: 'emerald', icon: <Scale className="w-5 h-5" />, logic: 'Problem–Solution' },
  media: { label: 'Media', color: 'orange', icon: <Newspaper className="w-5 h-5" />, logic: 'Narrative' }
};

// 3. MODULE REGISTRY (Tombol Template yang Muncul)
const MODULE_REGISTRY_DEFINITION = [
  { 
      id: 'journal_article', 
      name: 'Journal Article', 
      category: 'academic', 
      schema_version: SCHEMA_VERSION, 
      structural_sections: ['abstract','introduction','framework','methodology','findings','discussion','conclusion'], 
      color: 'blue', 
      description: 'Full empirical research paper.' 
  },
  
  /* --- AREA EDIT (PAK ANGGA): DAFTARKAN TOMBOL BARU DI SINI --- */
  
  { 
      id: 'project_proposal', // HARUS SAMA dengan ID di DUMMY_DATA dan GUIDANCE
      name: 'Project Proposal', // Nama yang muncul di tombol
      category: 'academic', // Kategori: 'academic', 'policy', atau 'media'
      schema_version: SCHEMA_VERSION, 
      // Urutan bagian-bagian dokumen
      structural_sections: ['executive_summary','problem_statement','objectives','implementation_plan','budget'], 
      color: 'blue', 
      description: 'Proposal pendanaan proyek standar.' 
  }, { 
  id: 'working_paper', 
  name: 'Working Paper', 
  category: 'academic', 
  schema_version: SCHEMA_VERSION, 
  structural_sections: ['abstract','introduction','literature_review','theoretical_framework','preliminary_analysis','discussion','conclusion'], 
  color: 'blue', 
  description: 'Preliminary research findings shared for feedback.' 
},
{ 
  id: 'dissertation_thesis', 
  name: 'Dissertation / Thesis', 
  category: 'academic', 
  schema_version: SCHEMA_VERSION, 
  structural_sections: ['abstract','introduction','literature_review','methodology','findings','discussion','conclusion','references'], 
  color: 'blue', 
  description: 'Original research for doctoral or master\'s degree.' 
},
{ 
  id: 'policy_brief', 
  name: 'Policy Brief', 
  category: 'policy', 
  schema_version: SCHEMA_VERSION, 
  structural_sections: ['executive_summary','key_recommendations','context','evidence','implications','conclusion'], 
  color: 'emerald', 
  description: 'Concise summary of policy issue and recommendations.' 
},
{ 
  id: 'policy_paper', 
  name: 'Policy Paper', 
  category: 'policy', 
  schema_version: SCHEMA_VERSION, 
  structural_sections: ['executive_summary','problem_definition','policy_options','analysis','recommendations','implementation'], 
  color: 'emerald', 
  description: 'Detailed analysis of policy options.' 
},
{ 
  id: 'white_paper', 
  name: 'White Paper', 
  category: 'policy', 
  schema_version: SCHEMA_VERSION, 
  structural_sections: ['executive_summary','introduction','current_challenges','proposed_solution','benefits','roadmap','conclusion'], 
  color: 'emerald', 
  description: 'Authoritative report on a specific issue and solution.' 
},
{ 
  id: 'position_paper', 
  name: 'Position Paper', 
  category: 'policy', 
  schema_version: SCHEMA_VERSION, 
  structural_sections: ['executive_summary','introduction','stance','arguments','counterarguments','conclusion'], 
  color: 'emerald', 
  description: 'Statement of an organization\'s or individual\'s position.' 
},
{ 
  id: 'technical_report', 
  name: 'Technical Report', 
  category: 'academic', 
  schema_version: SCHEMA_VERSION, 
  structural_sections: ['abstract','introduction','system_overview','methodology','results','discussion','conclusion'], 
  color: 'blue', 
  description: 'Documentation of technical research or development.' 
},
{ 
  id: 'guideline_sop', 
  name: 'Guideline / SOP Document', 
  category: 'policy', 
  schema_version: SCHEMA_VERSION, 
  structural_sections: ['purpose','scope','definitions','responsibilities','procedure','compliance','references'], 
  color: 'emerald', 
  description: 'Standard operating procedures or guidelines.' 
},
{ 
  id: 'regulatory_impact_assessment', 
  name: 'Regulatory Impact Assessment', 
  category: 'policy', 
  schema_version: SCHEMA_VERSION, 
  structural_sections: ['executive_summary','problem_identification','objectives','options','impact_analysis','consultation','recommendation'], 
  color: 'emerald', 
  description: 'Evaluation of effects of proposed regulations.' 
},

  /* ------------------------------------------------------------- */
  
  { id: 'conference_paper', name: 'Conference Paper', category: 'academic', schema_version: SCHEMA_VERSION, structural_sections: ['abstract','introduction','related_work','method','experiments','conclusion'], color: 'blue', description: 'Concise research contribution.' },
  { id: 'research_report', name: 'Research Report', category: 'academic', schema_version: SCHEMA_VERSION, structural_sections: ['executive_summary','background','methodology','findings','recommendations'], color: 'blue', description: 'Commissioned investigation.' }
];

/* ═══════════════════════════════════════════════════════════════
   LOGIC & UI (JANGAN DIUBAH KECUALI PAHAM REACT)
═══════════════════════════════════════════════════════════════ */

const colorMap = {
  blue: { bg: 'bg-blue-500/10', border: 'border-blue-500/30 hover:border-blue-500', text: 'text-blue-400', badge: 'bg-blue-900/50 text-blue-300 border-blue-500/30', glow: 'hover:shadow-blue-500/10' },
  emerald: { bg: 'bg-emerald-500/10', border: 'border-emerald-500/30 hover:border-emerald-500', text: 'text-emerald-400', badge: 'bg-emerald-900/50 text-emerald-300 border-emerald-500/30', glow: 'hover:shadow-emerald-500/10' },
  orange: { bg: 'bg-orange-500/10', border: 'border-orange-500/30 hover:border-orange-500', text: 'text-orange-400', badge: 'bg-orange-900/50 text-orange-300 border-orange-500/30', glow: 'hover:shadow-orange-500/10' }
};

class ModuleInstaller {
  constructor() { this.registry = {}; }
  install(modules) { modules.forEach(mod => this.registry[mod.id] = mod); }
  get(id) { return this.registry[id] || null; }
  getByCategory(cat) { return Object.values(this.registry).filter(m => m.category === cat); }
}
const installer = new ModuleInstaller();
installer.install(MODULE_REGISTRY_DEFINITION);
const generateId = () => Math.random().toString(36).substr(2, 9);
const buildModuleData = (moduleId, isTutorial) => {
  const mod = installer.get(moduleId);
  if (!mod) return null;
  const dummyMod = DUMMY_DATA[moduleId];
  const guidanceMod = GUIDANCE[moduleId] || {};
  const sections = mod.structural_sections.map(secKey => ({
    id: generateId(), sectionKey: secKey,
    content: isTutorial ? (dummyMod?.sections.find(s => s.key === secKey)?.content || `<h3>${secKey.replace(/_/g,' ')}</h3><p>...</p>`) : `<h3>${secKey.replace(/_/g,' ')}</h3><p>[Write here...]</p>`,
    guidance: { en: guidanceMod[secKey]?.en || { what: 'Write content.' }, id: guidanceMod[secKey]?.id || { what: 'Tulis konten.' } },
    analogy: { en: guidanceMod._analogy?.en, id: guidanceMod._analogy?.id },
    aiFeedback: null
  }));
  return { id: generateId(), moduleId, title: isTutorial ? (dummyMod?.title || mod.name) : `My ${mod.name}`, sections, metadata: mod };
};

/* ═══════════════════════════════════════════════════════════════
   UI COMPONENTS
═══════════════════════════════════════════════════════════════ */

const ErrorToast = ({ message, onClose, onRetry }) => {
    if (!message) return null;
    return (
        <div className="fixed bottom-6 right-6 max-w-sm w-full bg-slate-900 border border-red-500/50 text-white p-4 rounded-xl shadow-2xl z-[100] anim-up flex gap-3">
            <div className="p-2 bg-red-500/20 rounded-full h-fit">
                <AlertTriangle className="w-5 h-5 text-red-400" />
            </div>
            <div className="flex-1">
                <h4 className="font-bold text-red-400 text-sm mb-1">Proses AI Gagal</h4>
                <p className="text-xs text-slate-300 leading-relaxed mb-3">{message}</p>
                <div className="flex gap-2">
                    <button onClick={onRetry} className="flex-1 py-1.5 bg-red-600 hover:bg-red-700 rounded-lg text-[10px] font-bold transition-colors">
                        Coba Lagi
                    </button>
                    <button onClick={onClose} className="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-[10px] font-bold transition-colors">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    );
};

const AIMonitor = ({ status }) => {
    if (!status) return null;
    return (
        <div className="fixed bottom-6 left-6 bg-slate-900/90 backdrop-blur border border-blue-500/30 p-2.5 rounded-lg shadow-xl z-50 flex items-center gap-3 anim-fade">
            <div className="p-1.5 bg-blue-500/20 rounded-md">
                <Terminal className="w-3.5 h-3.5 text-blue-400" />
            </div>
            <span className="text-[10px] font-mono text-blue-300">{status}</span>
        </div>
    );
};

const RichTextEditor = ({ initialContent, onSave, onCancel }) => {
  const editorRef = useRef(null);
  const execCmd = (cmd, val = null) => { document.execCommand(cmd, false, val); editorRef.current.focus(); };
  return (
    <div className="border-2 border-blue-400 rounded-xl overflow-hidden bg-white flex flex-col shadow-lg anim-scale">
      <div className="bg-slate-50 border-b p-2 flex gap-1 items-center flex-wrap">
        <button onClick={() => execCmd('bold')} className="p-1.5 hover:bg-slate-200 rounded" title="Bold"><Bold className="w-3.5 h-3.5"/></button>
        <button onClick={() => execCmd('italic')} className="p-1.5 hover:bg-slate-200 rounded" title="Italic"><Italic className="w-3.5 h-3.5"/></button>
        <div className="w-px h-4 bg-slate-300 mx-1"/>
        <button onClick={() => execCmd('formatBlock','H3')} className="px-2 py-1 hover:bg-slate-200 rounded text-xs font-bold">H3</button>
        <button onClick={() => execCmd('formatBlock','P')} className="px-2 py-1 hover:bg-slate-200 rounded text-xs">¶</button>
        <div className="w-px h-4 bg-slate-300 mx-1"/>
        <button onClick={() => execCmd('insertUnorderedList')} className="p-1.5 hover:bg-slate-200 rounded"><List className="w-3.5 h-3.5"/></button>
        <button onClick={() => execCmd('insertOrderedList')} className="p-1.5 hover:bg-slate-200 rounded text-xs font-mono">1.</button>
      </div>
      <div ref={editorRef} className="p-4 outline-none prose-card text-sm" contentEditable suppressContentEditableWarning
        dangerouslySetInnerHTML={{ __html: initialContent }} style={{ minHeight: '140px' }}/>
      <div className="p-2 border-t bg-slate-50 flex justify-end gap-2">
        <button onClick={onCancel} className="px-3 py-1.5 text-xs text-slate-600 hover:bg-slate-100 rounded-lg">Batal</button>
        <button onClick={() => onSave(editorRef.current.innerHTML)} className="px-4 py-1.5 text-xs bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Simpan</button>
      </div>
    </div>
  );
};

const GuidancePanel = ({ section, moduleId, lang, onRunAI, isProcessing, setLang }) => {
  const [tab, setTab] = useState('what');
  
  if (!section) return (
    <div className="flex flex-col items-center justify-center h-full text-slate-500 p-6">
      <BookOpen className="w-12 h-12 mb-3 text-slate-300"/>
      <p className="text-sm text-center">Pilih bagian untuk melihat panduan</p>
    </div>
  );

  const g = section.guidance?.[lang] || {};
  const analogy = section.analogy?.[lang] || '';
  const tabs = [
    { id: 'what', label: lang === 'en' ? 'What to Write' : 'Apa yang Ditulis', icon: <PenTool className="w-3 h-3"/> },
    { id: 'why', label: lang === 'en' ? 'Why It Matters' : 'Mengapa Penting', icon: <Info className="w-3 h-3"/> },
    { id: 'mistakes', label: lang === 'en' ? 'Avoid' : 'Hindari', icon: <AlertCircle className="w-3 h-3"/> },
    { id: 'coach', label: lang === 'en' ? 'AI Coach' : 'Pelatih AI', icon: <GraduationCap className="w-3 h-3"/> }
  ];

  return (
    <div className="flex flex-col h-full anim-right">
      <div className="p-4 border-b bg-slate-50">
        <div className="flex justify-between items-start mb-2">
            <div className="text-xs font-bold uppercase tracking-wider text-slate-400">
            {section.sectionKey?.replace(/_/g,' ')}
            </div>
        </div>
        
        {analogy && (
          <div className="text-xs text-indigo-600 italic leading-relaxed bg-indigo-50 rounded-lg p-2 border border-indigo-100">
            💡 {analogy}
          </div>
        )}
      </div>

      <div className="flex border-b bg-white">
        {tabs.map(t => (
          <button key={t.id} onClick={() => setTab(t.id)}
            className={`flex-1 py-2 text-xs font-medium flex items-center justify-center gap-1 transition-colors border-b-2 ${
              tab === t.id ? 'border-blue-500 text-blue-600 bg-blue-50/50' : 'border-transparent text-slate-500 hover:text-slate-700'
            }`}>
            {t.icon} <span className="hidden sm:inline">{t.label}</span>
          </button>
        ))}
      </div>

      <div className="p-4 overflow-y-auto flex-1 custom-scrollbar">
        {tab === 'coach' ? (
          <div className="flex flex-col gap-4">
            <div className="bg-purple-50 border border-purple-100 rounded-xl p-3">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-1 bg-purple-200 rounded-lg"><GraduationCap className="w-4 h-4 text-purple-700"/></div>
                <h4 className="font-bold text-sm text-purple-900">Writing Coach</h4>
              </div>
              <p className="text-xs text-purple-800 mb-3">
                {lang === 'en' 
                    ? "I can analyze your draft against the section goals and provide specific structural feedback." 
                    : "Saya akan menganalisis draf Anda dan memberikan masukan struktural yang spesifik."}
              </p>
              <button onClick={onRunAI} disabled={isProcessing}
                className={`w-full py-2 rounded-lg text-xs font-bold text-white transition-all ${isProcessing ? 'bg-slate-400' : 'bg-purple-600 hover:bg-purple-700 shadow-md shadow-purple-200'}`}>
                {isProcessing ? (lang === 'en' ? 'Analyzing...' : 'Menganalisis...') : (lang === 'en' ? 'Analyze My Draft' : 'Analisis Draf Saya')}
              </button>
            </div>
            
            {section.aiFeedback && (
               <div className="prose-card text-sm p-3 bg-white border border-slate-200 rounded-xl shadow-sm animate-in fade-in slide-in-from-bottom-2">
                 <div className="text-xs font-bold text-slate-400 uppercase mb-2">Coach Feedback</div>
                 <div className="whitespace-pre-line leading-relaxed">{section.aiFeedback}</div>
               </div>
            )}
          </div>
        ) : (
          <p className="text-sm leading-relaxed text-slate-700">{g[tab]}</p>
        )}
      </div>
    </div>
  );
};

const ModuleDetailPanel = ({ mod, onSelect, onClose }) => {
  const cat = CATEGORY_CONFIG[mod.category];
  const col = colorMap[mod.color];
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm anim-fade">
      <div className="bg-slate-900 border border-slate-700 rounded-2xl max-w-lg w-full p-6 anim-scale shadow-2xl">
        <div className="flex justify-between items-start mb-4">
          <div>
            <div className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs border ${col.badge} mb-2`}>
              {cat.icon} {cat.label} · {cat.logic}
            </div>
            <h2 className="text-xl font-bold text-white">{mod.name}</h2>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400"><X className="w-4 h-4"/></button>
        </div>

        <p className="text-slate-400 text-sm mb-4">{mod.description}</p>
        <div className="flex gap-3 mt-8">
          <button onClick={() => onSelect(mod.id, false)} className="flex-1 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-sm font-semibold transition-colors">
            Mulai Kosong
          </button>
          <button onClick={() => onSelect(mod.id, true)} className="flex-1 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl text-sm font-semibold transition-colors">
            Muat Contoh
          </button>
        </div>
      </div>
    </div>
  );
};

const LandingPage = ({ onSelectTemplate, onImport }) => {
  const [activeCategory, setActiveCategory] = useState('academic');
  const [detailMod, setDetailMod] = useState(null);
  const modules = installer.getByCategory(activeCategory);

  return (
    <div className="min-h-screen bg-[#0a0f1e] text-white flex flex-col overflow-auto">
      <div className="relative z-10 flex flex-col items-center px-6 py-12">
        <div className="text-center mb-8 anim-up">
          <h1 className="text-5xl font-black mb-3 tracking-tight">
            Structure<span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-emerald-400">Flow</span>
          </h1>
          <p className="text-slate-400 max-w-md mx-auto">10 publication modules. Professional guidance. Bilingual intelligence.</p>
        </div>
        
        <div className="flex gap-2 mb-8 bg-slate-800/50 p-1 rounded-xl border border-slate-700/50 anim-up delay-2">
          {Object.entries(CATEGORY_CONFIG).map(([key, cat]) => (
            <button key={key} onClick={() => setActiveCategory(key)}
              className={`flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-semibold transition-all ${
                activeCategory === key
                  ? 'bg-slate-700 text-white shadow-lg'
                  : 'text-slate-400 hover:text-slate-300'
              }`}>
              {cat.icon} {cat.label}
            </button>
          ))}
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 max-w-7xl w-full mb-10 anim-up delay-3">
          {modules.map((mod, i) => {
            const col = colorMap[mod.color];
            return (
              <button key={mod.id}
                onClick={() => setDetailMod(mod)}
                className={`relative p-5 rounded-xl border ${col.border} bg-slate-800/60 backdrop-blur text-left transition-all duration-300 hover:-translate-y-0.5 hover:shadow-xl ${col.glow} group`}>
                <h3 className="font-bold text-slate-100 text-sm mb-1">{mod.name}</h3>
                <p className="text-xs text-slate-400 leading-relaxed mb-3">{mod.description}</p>
              </button>
            );
          })}
        </div>

        <label className="flex items-center gap-3 px-5 py-3 rounded-xl border border-dashed border-slate-600 hover:border-purple-500 bg-slate-800/30 cursor-pointer transition-colors group text-sm text-slate-400 hover:text-slate-300">
          <input type="file" onChange={onImport} className="hidden" accept=".json"/>
          <FolderOpen className="w-4 h-4 group-hover:text-purple-400 transition-colors"/>
          Muat sesi JSON yang disimpan sebelumnya
        </label>
      </div>

      {detailMod && (
        <ModuleDetailPanel
          mod={detailMod}
          onSelect={(id, isTutorial) => { setDetailMod(null); onSelectTemplate(id, isTutorial); }}
          onClose={() => setDetailMod(null)}
        />
      )}
    </div>
  );
};

/* ═══════════════════════════════════════════════════════════════
   MAIN APP
═══════════════════════════════════════════════════════════════ */

function App() {
  const [view, setView] = useState('landing');
  const [docData, setDocData] = useState(null);
  const [selectedIdx, setSelectedIdx] = useState(0);
  const [editingIdx, setEditingIdx] = useState(null);
  const [lang, setLang] = useState('en');
  
  const [apiKey, setApiKey] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [aiStatus, setAiStatus] = useState(null); 
  const [aiError, setAiError] = useState(null); 
  const [history, setHistory] = useState([]);
  const [retryAction, setRetryAction] = useState(null); 

  const pushHistory = () => {
    setHistory(prev => [...prev.slice(-9), JSON.parse(JSON.stringify(docData))]);
  };
  
  const handleUndo = () => {
    if (history.length === 0) return;
    const previous = history[history.length - 1];
    setHistory(prev => prev.slice(0, -1));
    setDocData(previous);
  };

  const handleNodecardAI = async (idx) => {
    if (!apiKey) { setAiError('API Key Diperlukan'); return; }
    pushHistory(); setIsProcessing(true); setAiError(null); setRetryAction(() => () => handleNodecardAI(idx));
    try {
      const section = docData.sections[idx];
      const prev = idx > 0 ? docData.sections[idx - 1] : null;
      const next = idx < docData.sections.length - 1 ? docData.sections[idx + 1] : null;
      const prompt = AI_BRIDGE.buildNodeContext(section, prev, next, docData, lang);
      
      const generatedContent = await AI_BRIDGE.generate(prompt, apiKey, setAiStatus);
      
      const updatedSections = [...docData.sections];
      updatedSections[idx] = { ...section, content: generatedContent };
      setDocData({ ...docData, sections: updatedSections });
      setAiStatus(null);
    } catch (e) { setAiError(e.message); setAiStatus(null); } finally { setIsProcessing(false); }
  };

  const handleGlobalAI = async () => {
    if (!apiKey) { setAiError('API Key Diperlukan'); return; }
    pushHistory(); setIsProcessing(true); setAiError(null); setRetryAction(() => () => handleGlobalAI());
    try {
        const prompt = AI_BRIDGE.buildGlobalContext(docData.sections, docData, lang);
        const rawJson = await AI_BRIDGE.generate(prompt, apiKey, setAiStatus);
        const cleanJson = rawJson.replace(/```json/g, '').replace(/```/g, '').trim();
        const updates = JSON.parse(cleanJson);
        const newSections = docData.sections.map(original => {
            const update = updates.find(u => u.id === original.id);
            return update ? { ...original, content: update.content } : original;
        });
        setDocData({ ...docData, sections: newSections });
        setAiStatus(null);
    } catch (e) { setAiError(e.message); setAiStatus(null); } finally { setIsProcessing(false); }
  };

  const handleGuidanceAI = async (idx) => {
    if (!apiKey) { setAiError('API Key Diperlukan'); return; }
    pushHistory(); setIsProcessing(true); setAiError(null); setRetryAction(() => () => handleGuidanceAI(idx));
    try {
        const section = docData.sections[idx];
        const prompt = AI_BRIDGE.buildGuidanceContext(section.content, section.guidance[lang], lang);
        const feedback = await AI_BRIDGE.generate(prompt, apiKey, setAiStatus);
        const updatedSections = [...docData.sections];
        updatedSections[idx] = { ...section, aiFeedback: feedback };
        setDocData({ ...docData, sections: updatedSections });
        setAiStatus(null);
    } catch (e) { setAiError(e.message); setAiStatus(null); } finally { setIsProcessing(false); }
  };

  const handleSelectTemplate = (moduleId, isTutorial) => {
    const data = buildModuleData(moduleId, isTutorial);
    if (!data) return;
    setDocData(data); setSelectedIdx(0); setEditingIdx(null); setView('workspace');
  };
  const handleImport = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const parsed = JSON.parse(ev.target.result);
        setDocData(parsed); setSelectedIdx(0); setView('workspace');
      } catch { alert('File JSON tidak valid.'); }
    };
    reader.readAsText(e.target.files[0]);
    e.target.value = '';
  };
  const handleSaveJSON = () => {
    const dataStr = JSON.stringify(docData, null, 2);
    const link = document.createElement('a');
    link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    link.download = `structureflow-${docData.moduleId}-${Date.now()}.json`;
    link.click();
  };
  const handleExportDoc = () => {
    const preHtml = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>${docData.title}</title><style>body { font-family: 'Calibri', sans-serif; }</style></head><body><h1>${docData.title}</h1>`;
    const contentHtml = docData.sections.map(s => `<div class="section">${s.content}</div><br/>`).join('');
    const fullHtml = preHtml + contentHtml + "</body></html>";
    const url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(fullHtml);
    const downloadLink = document.createElement("a");
    document.body.appendChild(downloadLink);
    downloadLink.href = url;
    downloadLink.download = `${docData.title}.doc`;
    downloadLink.click();
    document.body.removeChild(downloadLink);
  };
  
  const handleUpdateSection = (idx, content) => {
    const sections = [...docData.sections];
    sections[idx] = { ...sections[idx], content };
    setDocData({ ...docData, sections });
  };
  const handleAddSection = () => {
    const newSection = { id: generateId(), sectionKey: 'kustom', content: '<h3>Bagian Baru</h3><p>...</p>', guidance: { en: {}, id: {} }, children: [], aiFeedback: null };
    setDocData({ ...docData, sections: [...docData.sections, newSection] });
    setSelectedIdx(docData.sections.length);
  };
  const handleMove = (idx, dir) => {
    const sections = [...docData.sections];
    const target = idx + dir;
    if (target < 0 || target >= sections.length) return;
    [sections[idx], sections[target]] = [sections[target], sections[idx]];
    setDocData({ ...docData, sections });
    setSelectedIdx(target);
  };
  const handleDelete = (idx) => {
    if (!confirm('Hapus bagian ini?')) return;
    const sections = docData.sections.filter((_, i) => i !== idx);
    setDocData({ ...docData, sections });
    setSelectedIdx(Math.min(idx, sections.length - 1));
  };

  if (view === 'landing') return <LandingPage onSelectTemplate={handleSelectTemplate} onImport={handleImport}/>;

  const mod = docData?.metadata;
  const col = mod ? colorMap[mod.color] : colorMap.blue;
  const activeSection = docData?.sections?.[selectedIdx] || null;
  const hasKey = AI_BRIDGE.hasKey(apiKey);

  return (
    <div className={`flex flex-col h-screen bg-slate-100 overflow-hidden font-sans ${isProcessing ? 'cursor-wait' : ''}`}>
      
      {aiError && <ErrorToast message={aiError} onClose={() => setAiError(null)} onRetry={() => { setAiError(null); if(retryAction) retryAction(); }} />}
      <AIMonitor status={aiStatus} />

      <div className="bg-slate-900 text-white flex items-center justify-between px-4 py-2.5 z-30 no-print shadow-xl">
        <div className="flex items-center gap-3">
          <button onClick={() => setView('landing')} className="flex items-center gap-1 text-slate-400 hover:text-white text-sm transition-colors">
            <ChevronLeft className="w-4 h-4"/> Kembali
          </button>
          <div className="h-5 w-px bg-slate-700"/>
          <div className="flex items-center gap-2">
            <Cpu className="w-4 h-4 text-blue-400"/>
            {/* 2. GANTI NAMA DI HEADER SINI */}
            <span className="font-bold text-sm text-white">StructureFlow (Angga C.S.)</span>
          </div>
        </div>

        <div className="flex items-center gap-2 bg-slate-800 rounded-full px-3 py-1 border border-slate-700">
            <div className={`w-2 h-2 rounded-full ${hasKey ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]'}`} />
            <Lock className="w-3 h-3 text-slate-400"/>
            <input 
                type="password" 
                placeholder="Masukkan Gemini API Key" 
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                className="bg-transparent border-none text-xs text-white focus:outline-none w-48 placeholder:text-slate-600"
            />
        </div>

        <div className="flex items-center gap-1.5">
          <button onClick={handleUndo} disabled={history.length===0} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors disabled:opacity-50" title="Undo"><Undo className="w-4 h-4 text-orange-300"/></button>
          <div className="h-5 w-px bg-slate-700 mx-1"/>
          <button onClick={handleSaveJSON} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors" title="Simpan JSON"><Save className="w-4 h-4"/></button>
          <button onClick={handleExportDoc} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors" title="Unduh Word"><Download className="w-4 h-4 text-green-300"/></button>
          <button onClick={() => window.print()} className="p-2 bg-blue-700 hover:bg-blue-600 rounded-lg transition-colors" title="Cetak/PDF"><Printer className="w-4 h-4"/></button>
        </div>
      </div>

      <div className="flex flex-1 overflow-hidden">
        <div className="w-2/3 flex flex-col bg-slate-50 border-r overflow-hidden relative">
          
          {isProcessing && (
              <div className="absolute top-0 left-0 w-full h-1 z-50 ai-thinking"/>
          )}

          <div className="px-6 py-3 border-b bg-white/90 backdrop-blur flex items-center justify-between no-print">
            <div className="flex items-center gap-3">
              <span className="text-xs font-bold uppercase tracking-wider text-slate-400">Dokumen</span>
              <button onClick={handleGlobalAI} disabled={isProcessing}
                className="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 text-xs font-bold rounded-lg transition-colors border border-indigo-200 group">
                {isProcessing ? <Loader2 className="w-3 h-3 animate-spin"/> : <Brain className="w-3 h-3 group-hover:scale-110 transition-transform"/>}
                <span>Global Auto-Draft</span>
              </button>
            </div>
            <button onClick={handleAddSection} className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold rounded-full shadow-md"><Plus className="w-3 h-3"/> Tambah Bagian</button>
          </div>

          <div className="flex-1 overflow-y-auto px-8 py-8 custom-scrollbar">
            <div className="max-w-3xl mx-auto pb-24">
              {docData && (
                <input type="text" value={docData.title}
                  onChange={e => setDocData({ ...docData, title: e.target.value })}
                  className="w-full text-3xl font-black text-slate-800 mb-8 bg-transparent border-b-2 border-transparent hover:border-slate-200 focus:border-blue-400 focus:outline-none transition-all placeholder:text-slate-300 leading-tight"
                />
              )}

              {docData?.sections.map((section, idx) => {
                const isSelected = selectedIdx === idx;
                const isEditing = editingIdx === idx;
                return (
                  <div key={section.id} className="flex gap-3 group/row relative">
                    <div className="flex flex-col items-center w-6 pt-5 no-print flex-shrink-0">
                      <div className={`w-3 h-3 rounded-full border-2 z-10 transition-all duration-200 ${isSelected ? `bg-blue-500 border-blue-500 shadow-lg shadow-blue-400/30` : 'bg-white border-slate-300'}`}/>
                      {idx < docData.sections.length - 1 && <div className="w-0.5 bg-slate-200 flex-1 mt-1"/>}
                    </div>

                    <div className={`flex-1 mb-5 rounded-xl border-2 transition-all duration-200 bg-white cursor-pointer relative
                      ${isSelected ? 'border-blue-500 shadow-xl shadow-blue-500/10' : 'border-slate-200 hover:border-blue-200 hover:shadow-md'}`}
                      onClick={() => { setSelectedIdx(idx); }}>

                      <div className={`absolute -top-2.5 left-3 px-2 py-0.5 text-xs rounded-full border font-medium ${col.badge} no-print`}>
                        {section.sectionKey.replace(/_/g,' ')}
                      </div>

                      <div className="p-5 pt-6">
                        {isEditing ? (
                          <RichTextEditor
                            initialContent={section.content}
                            onSave={val => { handleUpdateSection(idx, val); setEditingIdx(null); }}
                            onCancel={() => setEditingIdx(null)}
                          />
                        ) : (
                          <div onDoubleClick={() => setEditingIdx(idx)}>
                            <div className="prose-card text-sm" dangerouslySetInnerHTML={{ __html: section.content }}/>
                            <div className={`absolute top-3 right-3 flex gap-1 bg-white rounded-lg border border-slate-200 p-0.5 shadow-sm no-print transition-opacity duration-200 ${isSelected ? 'opacity-100' : 'opacity-0 group-hover/row:opacity-100'}`}>
                              <button onClick={e => { e.stopPropagation(); handleNodecardAI(idx); }} disabled={isProcessing} className="p-1.5 hover:bg-purple-50 rounded text-purple-500 border-r border-slate-100" title="Revisi AI"><Sparkles className={`w-3 h-3 ${isProcessing && isSelected ? 'animate-spin' : ''}`}/></button>
                              <button onClick={e => { e.stopPropagation(); handleMove(idx, -1); }} className="p-1.5 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-700"><ArrowUp className="w-3 h-3"/></button>
                              <button onClick={e => { e.stopPropagation(); handleMove(idx, 1); }} className="p-1.5 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-700"><ArrowDown className="w-3 h-3"/></button>
                              <div className="w-px bg-slate-200 my-1"/>
                              <button onClick={e => { e.stopPropagation(); setEditingIdx(idx); }} className="p-1.5 hover:bg-blue-50 rounded text-blue-500"><Edit3 className="w-3 h-3"/></button>
                              <button onClick={e => { e.stopPropagation(); handleDelete(idx); }} className="p-1.5 hover:bg-red-50 rounded text-red-500"><Trash2 className="w-3 h-3"/></button>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        <div className="w-1/3 bg-white border-l flex flex-col no-print">
          <div className="px-4 py-3 border-b bg-slate-50 flex items-center justify-between">
            <div className="flex items-center gap-2 font-bold text-slate-700 text-sm">
              <BookOpen className="w-4 h-4 text-blue-500"/> Guidance Engine
            </div>
            
            <div className="flex items-center bg-slate-200 p-1 rounded-full cursor-pointer select-none" onClick={() => setLang(l => l === 'en' ? 'id' : 'en')}>
                <div className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all duration-200 ${lang === 'en' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-600'}`}>EN</div>
                <div className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all duration-200 ${lang === 'id' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-600'}`}>ID</div>
            </div>

          </div>
          <div className="flex-1 overflow-hidden">
            <GuidancePanel 
                section={activeSection} 
                moduleId={docData?.moduleId} 
                lang={lang} 
                onRunAI={() => handleGuidanceAI(selectedIdx)} 
                isProcessing={isProcessing}
                setLang={setLang}
            />
          </div>
        </div>
      </div>
    </div>
  );
}

createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
