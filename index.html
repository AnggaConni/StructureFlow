<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StructureFlow v3.4 â€” Toggle UI & Bilingual Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @keyframes fadeIn { from{opacity:0}to{opacity:1} }
        @keyframes slideUp { from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1} }
        @keyframes slideRight { from{transform:translateX(12px);opacity:0}to{transform:translateX(0);opacity:1} }
        @keyframes scaleIn { from{transform:scale(.96);opacity:0}to{transform:scale(1);opacity:1} }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 10%, 30%, 50%, 70%, 90% {transform: translateX(-4px);} 20%, 40%, 60%, 80% {transform: translateX(4px);} }
        .anim-fade { animation: fadeIn .35s ease both; }
        .anim-up { animation: slideUp .4s cubic-bezier(.22,1,.36,1) both; }
        .anim-right { animation: slideRight .3s ease both; }
        .anim-scale { animation: scaleIn .35s cubic-bezier(.22,1,.36,1) both; }
        .anim-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .delay-1 { animation-delay: .05s; }
        .delay-2 { animation-delay: .1s; }
        .delay-3 { animation-delay: .15s; }
        .delay-4 { animation-delay: .2s; }
        @media print { .no-print{display:none!important} }
        .prose-card h1,.prose-card h2,.prose-card h3{margin:.8em 0 .4em;font-weight:600;line-height:1.3}
        .prose-card h3{font-size:1rem;color:#1e40af}
        .prose-card p{margin-bottom:.7em;line-height:1.65;color:#374151}
        .prose-card ul,.prose-card ol{padding-left:1.4em;margin-bottom:.7em}
        .prose-card li{margin-bottom:.3em;color:#374151}
        .prose-card strong{color:#111827;font-weight:600}
        .prose-card em{color:#4b5563}
        .prose-card blockquote{border-left:3px solid #6366f1;padding:.5em 1em;background:#f5f3ff;margin:1em 0;border-radius:0 6px 6px 0;font-style:italic;color:#4338ca}
        
        /* AI Specific Styles */
        .ai-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        .ai-thinking { background: linear-gradient(270deg, #3b82f6, #8b5cf6, #3b82f6); background-size: 200% 200%; animation: gradient-move 2s ease infinite; }
        @keyframes gradient-move { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
<div id="root"></div>

<script type="text/babel" data-type="module">
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { createRoot } from 'react-dom/client';
import {
    Layout, Plus, Trash2, Edit3, Save, Upload, FileText,
    ArrowUp, ArrowDown, Globe, BookOpen, ChevronLeft,
    Bold, Italic, List, Printer, FolderOpen, Mail,
    Sparkles, GraduationCap, Scale, Newspaper, Megaphone,
    PenTool, BarChart2, Search, Tag, CheckCircle2,
    AlertCircle, Lightbulb, Library, Layers, Cpu, X,
    ChevronDown, ChevronRight, Star, Zap, Info,
    Brain, MessageSquare, Undo, Lock, Unlock, AlertTriangle, Loader2, Download,
    RefreshCw, Terminal
} from 'lucide-react';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI BRIDGE â€” Resilience Layer (FALLBACK ENABLED)
   Sekarang mendukung bahasa dinamis (EN/ID) di setiap prompt.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const AI_BRIDGE = {
    // Daftar model yang akan dicoba secara berurutan.
    models: [
        'gemini-2.5-flash-preview-09-2025', // Prioritas Utama
        'gemini-2.0-flash',                 // Next generation fast model
        'gemini-1.5-flash-latest',          // Stable latest
        'gemini-1.5-flash',                 // Standard
        'gemini-1.5-pro'                    // Heavy fallback
    ],
    
    // Safety check
    hasKey: (key) => !!key && key.length > 10,

    // Generator dengan log per model
    async generate(prompt, apiKey, onProgress) {
        if (!this.hasKey(apiKey)) {
            throw new Error("API Key Tidak Ditemukan atau Tidak Valid");
        }

        let lastError = null;

        for (const model of this.models) {
            try {
                if (onProgress) onProgress(`Mencoba model: ${model}...`);
                const result = await this._callModel(model, prompt, apiKey);
                return result; 
            } catch (e) {
                console.warn(`Model ${model} gagal:`, e.message);
                lastError = e;
                // Lanjut ke model berikutnya
            }
        }

        throw new Error(`Semua model AI gagal. Kesalahan terakhir: ${lastError?.message}`);
    },

    async _callModel(model, prompt, apiKey) {
        const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [{
                parts: [{ text: prompt }]
            }]
        };

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            let errorMessage = `Kesalahan HTTP ${response.status}`;
            try {
                const errorBody = await response.json();
                if (errorBody.error && errorBody.error.message) {
                    errorMessage = errorBody.error.message;
                }
            } catch (e) { }
            throw new Error(errorMessage);
        }
        
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
    },

    // 1. Nodecard AI (Updated: Accepts Lang)
    buildNodeContext: (currentSection, prevSection, nextSection, docMeta, lang) => {
        const targetLang = lang === 'en' ? 'English' : 'Indonesian (Bahasa Indonesia)';
        return `
        KONTEKS DOKUMEN:
        Judul: ${docMeta.title}
        Kategori: ${docMeta.metadata.category}
        Target Audiens: ${docMeta.metadata.target_audience}
        
        Konteks Bagian Sebelumnya: ${prevSection ? prevSection.content.replace(/<[^>]*>/g, '') : 'Awal dokumen'}
        Konteks Bagian Berikutnya: ${nextSection ? nextSection.content.replace(/<[^>]*>/g, '') : 'Akhir dokumen'}
        
        Nama Bagian Saat Ini: ${currentSection.sectionKey}
        Isi Saat Ini: ${currentSection.content.replace(/<[^>]*>/g, '')}
        
        TUGAS:
        Jika isi saat ini kosong, BUAT konten untuk bagian ini.
        Jika sudah ada isi, PERBAIKI dan TINGKATKAN kejelasan, alur, dan nadanya sesuai jenis dokumen.

        BAHASA OUTPUT (PENTING):
        Hasilkan konten sepenuhnya dalam: ${targetLang}.
        
        BATASAN:
        Kembalikan HANYA tag HTML valid (p, h3, ul, strong). Jangan gunakan markdown. Jangan gunakan pembungkus code block.
        `;
    },

    // 2. Global AI (Updated: Accepts Lang)
    buildGlobalContext: (sections, docMeta, lang) => {
        const targetLang = lang === 'en' ? 'English' : 'Indonesian (Bahasa Indonesia)';
        const outline = sections.map(s => ({
            id: s.id,
            key: s.sectionKey,
            isEmpty: s.content.includes('[Write here') || s.content.length < 50,
            content: s.content
        }));

        return `
        SYSTEM: Kamu adalah editor akademis dan profesional ahli.
        TUGAS: Tinjau struktur dokumen ini.
        1. Untuk bagian kosong, buat konten berdasarkan kunci bagian dan konteks sekitar.
        2. Untuk bagian yang sudah ada, pertajam bahasanya.
        3. Pertahankan hierarki struktural yang tepat.

        BAHASA OUTPUT (PENTING):
        Semua konten "content" dalam JSON harus ditulis dalam: ${targetLang}.
        
        DOKUMEN:
        Judul: ${docMeta.title}
        Jenis: ${docMeta.metadata.name}
        
        DATA INPUT (JSON):
        ${JSON.stringify(outline)}
        
        FORMAT OUTPUT:
        Kembalikan HANYA array JSON mentah berisi objek dengan field 'id' dan 'content'. 
        Contoh: [{"id": "123", "content": "<h3>...</h3><p>...</p>"}, ...]
        Jangan ubah ID. Jangan hapus node.
        `;
    },

    // 3. Guidance AI
    buildGuidanceContext: (sectionContent, guidanceData, lang) => {
        const targetLang = lang === 'en' ? 'English' : 'Indonesian (Bahasa Indonesia)';
        return `
        ACT AS: Writing coach ahli.
        LANGUAGE: ${targetLang}
        
        DRAFT USER:
        "${sectionContent.replace(/<[^>]*>/g, '')}"
        
        TUJUAN BAGIAN INI:
        ${guidanceData.what}
        
        TUGAS:
        Berikan 3 poin masukan spesifik.
        1. Kekuatan (apa yang sudah baik).
        2. Celah Struktural (apa yang kurang berdasarkan tujuan).
        3. Tips Perbaikan (bagaimana membuatnya lebih baik).
        
        BATASAN:
        Jangan tuliskan isinya untuk mereka. Tetap singkat (di bawah 100 kata).
        `;
    }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI COMPONENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const ErrorToast = ({ message, onClose, onRetry }) => {
    if (!message) return null;
    return (
        <div className="fixed bottom-6 right-6 max-w-sm w-full bg-slate-900 border border-red-500/50 text-white p-4 rounded-xl shadow-2xl z-[100] anim-up flex gap-3">
            <div className="p-2 bg-red-500/20 rounded-full h-fit">
                <AlertTriangle className="w-5 h-5 text-red-400" />
            </div>
            <div className="flex-1">
                <h4 className="font-bold text-red-400 text-sm mb-1">Proses AI Gagal</h4>
                <p className="text-xs text-slate-300 leading-relaxed mb-3">{message}</p>
                <div className="flex gap-2">
                    <button onClick={onRetry} className="flex-1 py-1.5 bg-red-600 hover:bg-red-700 rounded-lg text-[10px] font-bold transition-colors">
                        Coba Lagi
                    </button>
                    <button onClick={onClose} className="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-[10px] font-bold transition-colors">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    );
};

// Component for real-time model logs
const AIMonitor = ({ status }) => {
    if (!status) return null;
    return (
        <div className="fixed bottom-6 left-6 bg-slate-900/90 backdrop-blur border border-blue-500/30 p-2.5 rounded-lg shadow-xl z-50 flex items-center gap-3 anim-fade">
            <div className="p-1.5 bg-blue-500/20 rounded-md">
                <Terminal className="w-3.5 h-3.5 text-blue-400" />
            </div>
            <span className="text-[10px] font-mono text-blue-300">{status}</span>
        </div>
    );
};

const RichTextEditor = ({ initialContent, onSave, onCancel }) => {
  const editorRef = useRef(null);
  const execCmd = (cmd, val = null) => { document.execCommand(cmd, false, val); editorRef.current.focus(); };
  return (
    <div className="border-2 border-blue-400 rounded-xl overflow-hidden bg-white flex flex-col shadow-lg anim-scale">
      <div className="bg-slate-50 border-b p-2 flex gap-1 items-center flex-wrap">
        <button onClick={() => execCmd('bold')} className="p-1.5 hover:bg-slate-200 rounded" title="Bold"><Bold className="w-3.5 h-3.5"/></button>
        <button onClick={() => execCmd('italic')} className="p-1.5 hover:bg-slate-200 rounded" title="Italic"><Italic className="w-3.5 h-3.5"/></button>
        <div className="w-px h-4 bg-slate-300 mx-1"/>
        <button onClick={() => execCmd('formatBlock','H3')} className="px-2 py-1 hover:bg-slate-200 rounded text-xs font-bold">H3</button>
        <button onClick={() => execCmd('formatBlock','P')} className="px-2 py-1 hover:bg-slate-200 rounded text-xs">Â¶</button>
        <div className="w-px h-4 bg-slate-300 mx-1"/>
        <button onClick={() => execCmd('insertUnorderedList')} className="p-1.5 hover:bg-slate-200 rounded"><List className="w-3.5 h-3.5"/></button>
        <button onClick={() => execCmd('insertOrderedList')} className="p-1.5 hover:bg-slate-200 rounded text-xs font-mono">1.</button>
      </div>
      <div ref={editorRef} className="p-4 outline-none prose-card text-sm" contentEditable suppressContentEditableWarning
        dangerouslySetInnerHTML={{ __html: initialContent }} style={{ minHeight: '140px' }}/>
      <div className="p-2 border-t bg-slate-50 flex justify-end gap-2">
        <button onClick={onCancel} className="px-3 py-1.5 text-xs text-slate-600 hover:bg-slate-100 rounded-lg">Batal</button>
        <button onClick={() => onSave(editorRef.current.innerHTML)} className="px-4 py-1.5 text-xs bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Simpan</button>
      </div>
    </div>
  );
};

const GuidancePanel = ({ section, moduleId, lang, onRunAI, isProcessing, setLang }) => {
  const [tab, setTab] = useState('what');
  
  if (!section) return (
    <div className="flex flex-col items-center justify-center h-full text-slate-500 p-6">
      <BookOpen className="w-12 h-12 mb-3 text-slate-300"/>
      <p className="text-sm text-center">Pilih bagian untuk melihat panduan</p>
    </div>
  );

  const g = section.guidance?.[lang] || {};
  const analogy = section.analogy?.[lang] || '';
  const tabs = [
    { id: 'what', label: lang === 'en' ? 'What to Write' : 'Apa yang Ditulis', icon: <PenTool className="w-3 h-3"/> },
    { id: 'why', label: lang === 'en' ? 'Why It Matters' : 'Mengapa Penting', icon: <Info className="w-3 h-3"/> },
    { id: 'mistakes', label: lang === 'en' ? 'Avoid' : 'Hindari', icon: <AlertCircle className="w-3 h-3"/> },
    { id: 'coach', label: lang === 'en' ? 'AI Coach' : 'Pelatih AI', icon: <GraduationCap className="w-3 h-3"/> }
  ];

  return (
    <div className="flex flex-col h-full anim-right">
      <div className="p-4 border-b bg-slate-50">
        <div className="flex justify-between items-start mb-2">
            <div className="text-xs font-bold uppercase tracking-wider text-slate-400">
            {section.sectionKey?.replace(/_/g,' ')}
            </div>
        </div>
        
        {analogy && (
          <div className="text-xs text-indigo-600 italic leading-relaxed bg-indigo-50 rounded-lg p-2 border border-indigo-100">
            ðŸ’¡ {analogy}
          </div>
        )}
      </div>

      <div className="flex border-b bg-white">
        {tabs.map(t => (
          <button key={t.id} onClick={() => setTab(t.id)}
            className={`flex-1 py-2 text-xs font-medium flex items-center justify-center gap-1 transition-colors border-b-2 ${
              tab === t.id ? 'border-blue-500 text-blue-600 bg-blue-50/50' : 'border-transparent text-slate-500 hover:text-slate-700'
            }`}>
            {t.icon} <span className="hidden sm:inline">{t.label}</span>
          </button>
        ))}
      </div>

      <div className="p-4 overflow-y-auto flex-1 custom-scrollbar">
        {tab === 'coach' ? (
          <div className="flex flex-col gap-4">
            <div className="bg-purple-50 border border-purple-100 rounded-xl p-3">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-1 bg-purple-200 rounded-lg"><GraduationCap className="w-4 h-4 text-purple-700"/></div>
                <h4 className="font-bold text-sm text-purple-900">Writing Coach</h4>
              </div>
              <p className="text-xs text-purple-800 mb-3">
                {lang === 'en' 
                    ? "I can analyze your draft against the section goals and provide specific structural feedback." 
                    : "Saya akan menganalisis draf Anda dan memberikan masukan struktural yang spesifik."}
              </p>
              <button onClick={onRunAI} disabled={isProcessing}
                className={`w-full py-2 rounded-lg text-xs font-bold text-white transition-all ${isProcessing ? 'bg-slate-400' : 'bg-purple-600 hover:bg-purple-700 shadow-md shadow-purple-200'}`}>
                {isProcessing ? (lang === 'en' ? 'Analyzing...' : 'Menganalisis...') : (lang === 'en' ? 'Analyze My Draft' : 'Analisis Draf Saya')}
              </button>
            </div>
            
            {section.aiFeedback && (
               <div className="prose-card text-sm p-3 bg-white border border-slate-200 rounded-xl shadow-sm animate-in fade-in slide-in-from-bottom-2">
                 <div className="text-xs font-bold text-slate-400 uppercase mb-2">Coach Feedback</div>
                 <div className="whitespace-pre-line leading-relaxed">{section.aiFeedback}</div>
               </div>
            )}
          </div>
        ) : (
          <p className="text-sm leading-relaxed text-slate-700">{g[tab]}</p>
        )}
      </div>
    </div>
  );
};

const ModuleDetailPanel = ({ mod, onSelect, onClose }) => {
  const cat = CATEGORY_CONFIG[mod.category];
  const col = colorMap[mod.color];
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm anim-fade">
      <div className="bg-slate-900 border border-slate-700 rounded-2xl max-w-lg w-full p-6 anim-scale shadow-2xl">
        <div className="flex justify-between items-start mb-4">
          <div>
            <div className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs border ${col.badge} mb-2`}>
              {cat.icon} {cat.label} Â· {cat.logic}
            </div>
            <h2 className="text-xl font-bold text-white">{mod.name}</h2>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400"><X className="w-4 h-4"/></button>
        </div>

        <p className="text-slate-400 text-sm mb-4">{mod.description}</p>
        <div className="flex gap-3 mt-8">
          <button onClick={() => onSelect(mod.id, false)} className="flex-1 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-sm font-semibold transition-colors">
            Mulai Kosong
          </button>
          <button onClick={() => onSelect(mod.id, true)} className="flex-1 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl text-sm font-semibold transition-colors">
            Muat Contoh
          </button>
        </div>
      </div>
    </div>
  );
};

const LandingPage = ({ onSelectTemplate, onImport }) => {
  const [activeCategory, setActiveCategory] = useState('academic');
  const [detailMod, setDetailMod] = useState(null);
  const modules = installer.getByCategory(activeCategory);

  return (
    <div className="min-h-screen bg-[#0a0f1e] text-white flex flex-col overflow-auto">
      <div className="relative z-10 flex flex-col items-center px-6 py-12">
        <div className="text-center mb-8 anim-up">
          <h1 className="text-5xl font-black mb-3 tracking-tight">
            Structure<span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-emerald-400">Flow</span>
          </h1>
          <p className="text-slate-400 max-w-md mx-auto">10 publication modules. Professional guidance. Bilingual intelligence.</p>
        </div>
        
        <div className="flex gap-2 mb-8 bg-slate-800/50 p-1 rounded-xl border border-slate-700/50 anim-up delay-2">
          {Object.entries(CATEGORY_CONFIG).map(([key, cat]) => (
            <button key={key} onClick={() => setActiveCategory(key)}
              className={`flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-semibold transition-all ${
                activeCategory === key
                  ? 'bg-slate-700 text-white shadow-lg'
                  : 'text-slate-400 hover:text-slate-300'
              }`}>
              {cat.icon} {cat.label}
            </button>
          ))}
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 max-w-7xl w-full mb-10 anim-up delay-3">
          {modules.map((mod, i) => {
            const col = colorMap[mod.color];
            return (
              <button key={mod.id}
                onClick={() => setDetailMod(mod)}
                className={`relative p-5 rounded-xl border ${col.border} bg-slate-800/60 backdrop-blur text-left transition-all duration-300 hover:-translate-y-0.5 hover:shadow-xl ${col.glow} group`}>
                <h3 className="font-bold text-slate-100 text-sm mb-1">{mod.name}</h3>
                <p className="text-xs text-slate-400 leading-relaxed mb-3">{mod.description}</p>
              </button>
            );
          })}
        </div>

        <label className="flex items-center gap-3 px-5 py-3 rounded-xl border border-dashed border-slate-600 hover:border-purple-500 bg-slate-800/30 cursor-pointer transition-colors group text-sm text-slate-400 hover:text-slate-300">
          <input type="file" onChange={onImport} className="hidden" accept=".json"/>
          <FolderOpen className="w-4 h-4 group-hover:text-purple-400 transition-colors"/>
          Muat sesi JSON yang disimpan sebelumnya
        </label>
      </div>

      {detailMod && (
        <ModuleDetailPanel
          mod={detailMod}
          onSelect={(id, isTutorial) => { setDetailMod(null); onSelectTemplate(id, isTutorial); }}
          onClose={() => setDetailMod(null)}
        />
      )}
    </div>
  );
};

const SCHEMA_VERSION = '3.0.0';
const DUMMY_DATA = {
  journal_article: {
    title: 'The Impact of Digital Collaboration Tools',
    sections: [
      { key: 'abstract', content: `<h3>Abstract</h3><p>This study examines the relationship between enterprise digital collaboration tools and knowledge-worker productivity.</p>` },
      { key: 'introduction', content: `<h3>1. Introduction</h3><p>The unprecedented shift to remote work during 2020â€“2021 compressed a decade of organizational experimentation.</p>` },
      { key: 'framework', content: `<h3>2. Theoretical Framework</h3><p>Our framework synthesizes Media Synchronicity Theory and Cognitive Load Theory.</p>` },
      { key: 'methodology', content: `<h3>3. Methodology</h3><p>A mixed-methods design combining survey (n=412) and interviews (n=24).</p>` },
      { key: 'findings', content: `<h3>4. Findings</h3><p>Tool integration depth was found to be the primary predictor of deep work capacity.</p>` },
      { key: 'discussion', content: `<h3>5. Discussion</h3><p>Results suggest organizations must move beyond tool adoption to tool governance.</p>` },
      { key: 'conclusion', content: `<h3>6. Conclusion</h3><p>We propose a configuration model for remote ecosystems.</p>` }
    ]
  },
  conference_paper: { title: 'Adaptive Attention Mechanisms', sections: [] },
  research_report: { title: 'Urban Mobility Transitions', sections: [] }
};
const GUIDANCE = {
  journal_article: {
    _analogy: { en: 'A journal article is a courtroom argument.', id: 'Artikel jurnal ibarat argumen di pengadilan.' },
    abstract: {
      en: { what: 'Self-contained summary of the entire paper.', tip: 'Think of it as a movie trailer.' },
      id: { what: 'Ringkasan mandiri seluruh makalah.', tip: 'Bayangkan seperti trailer film.' }
    }
  }
};
const CATEGORY_CONFIG = {
  academic: { label: 'Academic', color: 'blue', icon: <GraduationCap className="w-5 h-5" />, logic: 'IMRaD' },
  policy: { label: 'Policy', color: 'emerald', icon: <Scale className="w-5 h-5" />, logic: 'Problemâ€“Solution' },
  media: { label: 'Media', color: 'orange', icon: <Newspaper className="w-5 h-5" />, logic: 'Narrative' }
};
const colorMap = {
  blue: { bg: 'bg-blue-500/10', border: 'border-blue-500/30 hover:border-blue-500', text: 'text-blue-400', badge: 'bg-blue-900/50 text-blue-300 border-blue-500/30', glow: 'hover:shadow-blue-500/10' },
  emerald: { bg: 'bg-emerald-500/10', border: 'border-emerald-500/30 hover:border-emerald-500', text: 'text-emerald-400', badge: 'bg-emerald-900/50 text-emerald-300 border-emerald-500/30', glow: 'hover:shadow-emerald-500/10' },
  orange: { bg: 'bg-orange-500/10', border: 'border-orange-500/30 hover:border-orange-500', text: 'text-orange-400', badge: 'bg-orange-900/50 text-orange-300 border-orange-500/30', glow: 'hover:shadow-orange-500/10' }
};
const MODULE_REGISTRY_DEFINITION = [
  { id: 'journal_article', name: 'Journal Article', category: 'academic', schema_version: SCHEMA_VERSION, structural_sections: ['abstract','introduction','framework','methodology','findings','discussion','conclusion'], color: 'blue', description: 'Full empirical research paper.' },
  { id: 'conference_paper', name: 'Conference Paper', category: 'academic', schema_version: SCHEMA_VERSION, structural_sections: ['abstract','introduction','related_work','method','experiments','conclusion'], color: 'blue', description: 'Concise research contribution.' },
  { id: 'research_report', name: 'Research Report', category: 'academic', schema_version: SCHEMA_VERSION, structural_sections: ['executive_summary','background','methodology','findings','recommendations'], color: 'blue', description: 'Commissioned investigation.' }
];

class ModuleInstaller {
  constructor() { this.registry = {}; }
  install(modules) { modules.forEach(mod => this.registry[mod.id] = mod); }
  get(id) { return this.registry[id] || null; }
  getByCategory(cat) { return Object.values(this.registry).filter(m => m.category === cat); }
}
const installer = new ModuleInstaller();
installer.install(MODULE_REGISTRY_DEFINITION);
const generateId = () => Math.random().toString(36).substr(2, 9);
const buildModuleData = (moduleId, isTutorial) => {
  const mod = installer.get(moduleId);
  if (!mod) return null;
  const dummyMod = DUMMY_DATA[moduleId];
  const guidanceMod = GUIDANCE[moduleId] || {};
  const sections = mod.structural_sections.map(secKey => ({
    id: generateId(), sectionKey: secKey,
    content: isTutorial ? (dummyMod?.sections.find(s => s.key === secKey)?.content || `<h3>${secKey}</h3><p>...</p>`) : `<h3>${secKey.replace(/_/g,' ')}</h3><p>[Write here...]</p>`,
    guidance: { en: guidanceMod[secKey]?.en || { what: 'Write content.' }, id: guidanceMod[secKey]?.id || { what: 'Tulis konten.' } },
    analogy: { en: guidanceMod._analogy?.en, id: guidanceMod._analogy?.id },
    aiFeedback: null
  }));
  return { id: generateId(), moduleId, title: isTutorial ? (dummyMod?.title || mod.name) : `My ${mod.name}`, sections, metadata: mod };
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function App() {
  const [view, setView] = useState('landing');
  const [docData, setDocData] = useState(null);
  const [selectedIdx, setSelectedIdx] = useState(0);
  const [editingIdx, setEditingIdx] = useState(null);
  const [lang, setLang] = useState('en');
  
  // AI STATE
  const [apiKey, setApiKey] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [aiStatus, setAiStatus] = useState(null); // Tracking current model attempt
  const [aiError, setAiError] = useState(null); 
  const [history, setHistory] = useState([]);
  const [retryAction, setRetryAction] = useState(null); // To store the last failed function

  const pushHistory = () => {
    setHistory(prev => [...prev.slice(-9), JSON.parse(JSON.stringify(docData))]);
  };
  
  const handleUndo = () => {
    if (history.length === 0) return;
    const previous = history[history.length - 1];
    setHistory(prev => prev.slice(0, -1));
    setDocData(previous);
  };

  /* AI FUNCTIONS (Updated with model logging & fallback fix) */
  const handleNodecardAI = async (idx) => {
    if (!apiKey) { setAiError('API Key Diperlukan'); return; }
    pushHistory(); setIsProcessing(true); setAiError(null); setRetryAction(() => () => handleNodecardAI(idx));
    try {
      const section = docData.sections[idx];
      const prev = idx > 0 ? docData.sections[idx - 1] : null;
      const next = idx < docData.sections.length - 1 ? docData.sections[idx + 1] : null;
      // AUDITOR FIX: Passed 'lang' to context builder
      const prompt = AI_BRIDGE.buildNodeContext(section, prev, next, docData, lang);
      
      const generatedContent = await AI_BRIDGE.generate(prompt, apiKey, setAiStatus);
      
      const updatedSections = [...docData.sections];
      updatedSections[idx] = { ...section, content: generatedContent };
      setDocData({ ...docData, sections: updatedSections });
      setAiStatus(null);
    } catch (e) { setAiError(e.message); setAiStatus(null); } finally { setIsProcessing(false); }
  };

  const handleGlobalAI = async () => {
    if (!apiKey) { setAiError('API Key Diperlukan'); return; }
    pushHistory(); setIsProcessing(true); setAiError(null); setRetryAction(() => () => handleGlobalAI());
    try {
        // AUDITOR FIX: Passed 'lang' to context builder
        const prompt = AI_BRIDGE.buildGlobalContext(docData.sections, docData, lang);
        const rawJson = await AI_BRIDGE.generate(prompt, apiKey, setAiStatus);
        const cleanJson = rawJson.replace(/```json/g, '').replace(/```/g, '').trim();
        const updates = JSON.parse(cleanJson);
        const newSections = docData.sections.map(original => {
            const update = updates.find(u => u.id === original.id);
            return update ? { ...original, content: update.content } : original;
        });
        setDocData({ ...docData, sections: newSections });
        setAiStatus(null);
    } catch (e) { setAiError(e.message); setAiStatus(null); } finally { setIsProcessing(false); }
  };

  const handleGuidanceAI = async (idx) => {
    if (!apiKey) { setAiError('API Key Diperlukan'); return; }
    pushHistory(); setIsProcessing(true); setAiError(null); setRetryAction(() => () => handleGuidanceAI(idx));
    try {
        const section = docData.sections[idx];
        const prompt = AI_BRIDGE.buildGuidanceContext(section.content, section.guidance[lang], lang);
        const feedback = await AI_BRIDGE.generate(prompt, apiKey, setAiStatus);
        const updatedSections = [...docData.sections];
        updatedSections[idx] = { ...section, aiFeedback: feedback };
        setDocData({ ...docData, sections: updatedSections });
        setAiStatus(null);
    } catch (e) { setAiError(e.message); setAiStatus(null); } finally { setIsProcessing(false); }
  };

  /* BASIC HANDLERS */
  const handleSelectTemplate = (moduleId, isTutorial) => {
    const data = buildModuleData(moduleId, isTutorial);
    if (!data) return;
    setDocData(data); setSelectedIdx(0); setEditingIdx(null); setView('workspace');
  };
  const handleImport = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const parsed = JSON.parse(ev.target.result);
        setDocData(parsed); setSelectedIdx(0); setView('workspace');
      } catch { alert('File JSON tidak valid.'); }
    };
    reader.readAsText(e.target.files[0]);
    e.target.value = '';
  };
  const handleSaveJSON = () => {
    const dataStr = JSON.stringify(docData, null, 2);
    const link = document.createElement('a');
    link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    link.download = `structureflow-${docData.moduleId}-${Date.now()}.json`;
    link.click();
  };
  const handleExportDoc = () => {
    const preHtml = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>${docData.title}</title><style>body { font-family: 'Calibri', sans-serif; }</style></head><body><h1>${docData.title}</h1>`;
    const contentHtml = docData.sections.map(s => `<div class="section">${s.content}</div><br/>`).join('');
    const fullHtml = preHtml + contentHtml + "</body></html>";
    const url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(fullHtml);
    const downloadLink = document.createElement("a");
    document.body.appendChild(downloadLink);
    downloadLink.href = url;
    downloadLink.download = `${docData.title}.doc`;
    downloadLink.click();
    document.body.removeChild(downloadLink);
  };
  
  const handleUpdateSection = (idx, content) => {
    const sections = [...docData.sections];
    sections[idx] = { ...sections[idx], content };
    setDocData({ ...docData, sections });
  };
  const handleAddSection = () => {
    const newSection = { id: generateId(), sectionKey: 'kustom', content: '<h3>Bagian Baru</h3><p>...</p>', guidance: { en: {}, id: {} }, children: [], aiFeedback: null };
    setDocData({ ...docData, sections: [...docData.sections, newSection] });
    setSelectedIdx(docData.sections.length);
  };
  const handleMove = (idx, dir) => {
    const sections = [...docData.sections];
    const target = idx + dir;
    if (target < 0 || target >= sections.length) return;
    [sections[idx], sections[target]] = [sections[target], sections[idx]];
    setDocData({ ...docData, sections });
    setSelectedIdx(target);
  };
  const handleDelete = (idx) => {
    if (!confirm('Hapus bagian ini?')) return;
    const sections = docData.sections.filter((_, i) => i !== idx);
    setDocData({ ...docData, sections });
    setSelectedIdx(Math.min(idx, sections.length - 1));
  };

  if (view === 'landing') return <LandingPage onSelectTemplate={handleSelectTemplate} onImport={handleImport}/>;

  const mod = docData?.metadata;
  const col = mod ? colorMap[mod.color] : colorMap.blue;
  const activeSection = docData?.sections?.[selectedIdx] || null;
  const hasKey = AI_BRIDGE.hasKey(apiKey);

  return (
    <div className={`flex flex-col h-screen bg-slate-100 overflow-hidden font-sans ${isProcessing ? 'cursor-wait' : ''}`}>
      
      {aiError && <ErrorToast message={aiError} onClose={() => setAiError(null)} onRetry={() => { setAiError(null); if(retryAction) retryAction(); }} />}
      <AIMonitor status={aiStatus} />

      {/* TOP BAR */}
      <div className="bg-slate-900 text-white flex items-center justify-between px-4 py-2.5 z-30 no-print shadow-xl">
        <div className="flex items-center gap-3">
          <button onClick={() => setView('landing')} className="flex items-center gap-1 text-slate-400 hover:text-white text-sm transition-colors">
            <ChevronLeft className="w-4 h-4"/> Kembali
          </button>
          <div className="h-5 w-px bg-slate-700"/>
          <div className="flex items-center gap-2">
            <Cpu className="w-4 h-4 text-blue-400"/>
            <span className="font-bold text-sm text-white">StructureFlow</span>
          </div>
        </div>

        <div className="flex items-center gap-2 bg-slate-800 rounded-full px-3 py-1 border border-slate-700">
            <div className={`w-2 h-2 rounded-full ${hasKey ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]'}`} />
            <Lock className="w-3 h-3 text-slate-400"/>
            <input 
                type="password" 
                placeholder="Masukkan Gemini API Key" 
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                className="bg-transparent border-none text-xs text-white focus:outline-none w-48 placeholder:text-slate-600"
            />
        </div>

        <div className="flex items-center gap-1.5">
          <button onClick={handleUndo} disabled={history.length===0} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors disabled:opacity-50" title="Undo"><Undo className="w-4 h-4 text-orange-300"/></button>
          <div className="h-5 w-px bg-slate-700 mx-1"/>
          <button onClick={handleSaveJSON} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors" title="Simpan JSON"><Save className="w-4 h-4"/></button>
          <button onClick={handleExportDoc} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors" title="Unduh Word"><Download className="w-4 h-4 text-green-300"/></button>
          <button onClick={() => window.print()} className="p-2 bg-blue-700 hover:bg-blue-600 rounded-lg transition-colors" title="Cetak/PDF"><Printer className="w-4 h-4"/></button>
        </div>
      </div>

      {/* WORKSPACE */}
      <div className="flex flex-1 overflow-hidden">
        <div className="w-2/3 flex flex-col bg-slate-50 border-r overflow-hidden relative">
          
          {isProcessing && (
              <div className="absolute top-0 left-0 w-full h-1 z-50 ai-thinking"/>
          )}

          <div className="px-6 py-3 border-b bg-white/90 backdrop-blur flex items-center justify-between no-print">
            <div className="flex items-center gap-3">
              <span className="text-xs font-bold uppercase tracking-wider text-slate-400">Dokumen</span>
              <button onClick={handleGlobalAI} disabled={isProcessing}
                className="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 text-xs font-bold rounded-lg transition-colors border border-indigo-200 group">
                {isProcessing ? <Loader2 className="w-3 h-3 animate-spin"/> : <Brain className="w-3 h-3 group-hover:scale-110 transition-transform"/>}
                <span>Global Auto-Draft</span>
              </button>
            </div>
            <button onClick={handleAddSection} className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold rounded-full shadow-md"><Plus className="w-3 h-3"/> Tambah Bagian</button>
          </div>

          <div className="flex-1 overflow-y-auto px-8 py-8 custom-scrollbar">
            <div className="max-w-3xl mx-auto pb-24">
              {docData && (
                <input type="text" value={docData.title}
                  onChange={e => setDocData({ ...docData, title: e.target.value })}
                  className="w-full text-3xl font-black text-slate-800 mb-8 bg-transparent border-b-2 border-transparent hover:border-slate-200 focus:border-blue-400 focus:outline-none transition-all placeholder:text-slate-300 leading-tight"
                />
              )}

              {docData?.sections.map((section, idx) => {
                const isSelected = selectedIdx === idx;
                const isEditing = editingIdx === idx;
                return (
                  <div key={section.id} className="flex gap-3 group/row relative">
                    <div className="flex flex-col items-center w-6 pt-5 no-print flex-shrink-0">
                      <div className={`w-3 h-3 rounded-full border-2 z-10 transition-all duration-200 ${isSelected ? `bg-blue-500 border-blue-500 shadow-lg shadow-blue-400/30` : 'bg-white border-slate-300'}`}/>
                      {idx < docData.sections.length - 1 && <div className="w-0.5 bg-slate-200 flex-1 mt-1"/>}
                    </div>

                    <div className={`flex-1 mb-5 rounded-xl border-2 transition-all duration-200 bg-white cursor-pointer relative
                      ${isSelected ? 'border-blue-500 shadow-xl shadow-blue-500/10' : 'border-slate-200 hover:border-blue-200 hover:shadow-md'}`}
                      onClick={() => { setSelectedIdx(idx); }}>

                      <div className={`absolute -top-2.5 left-3 px-2 py-0.5 text-xs rounded-full border font-medium ${col.badge} no-print`}>
                        {section.sectionKey.replace(/_/g,' ')}
                      </div>

                      <div className="p-5 pt-6">
                        {isEditing ? (
                          <RichTextEditor
                            initialContent={section.content}
                            onSave={val => { handleUpdateSection(idx, val); setEditingIdx(null); }}
                            onCancel={() => setEditingIdx(null)}
                          />
                        ) : (
                          <div onDoubleClick={() => setEditingIdx(idx)}>
                            <div className="prose-card text-sm" dangerouslySetInnerHTML={{ __html: section.content }}/>
                            <div className={`absolute top-3 right-3 flex gap-1 bg-white rounded-lg border border-slate-200 p-0.5 shadow-sm no-print transition-opacity duration-200 ${isSelected ? 'opacity-100' : 'opacity-0 group-hover/row:opacity-100'}`}>
                              <button onClick={e => { e.stopPropagation(); handleNodecardAI(idx); }} disabled={isProcessing} className="p-1.5 hover:bg-purple-50 rounded text-purple-500 border-r border-slate-100" title="Revisi AI"><Sparkles className={`w-3 h-3 ${isProcessing && isSelected ? 'animate-spin' : ''}`}/></button>
                              <button onClick={e => { e.stopPropagation(); handleMove(idx, -1); }} className="p-1.5 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-700"><ArrowUp className="w-3 h-3"/></button>
                              <button onClick={e => { e.stopPropagation(); handleMove(idx, 1); }} className="p-1.5 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-700"><ArrowDown className="w-3 h-3"/></button>
                              <div className="w-px bg-slate-200 my-1"/>
                              <button onClick={e => { e.stopPropagation(); setEditingIdx(idx); }} className="p-1.5 hover:bg-blue-50 rounded text-blue-500"><Edit3 className="w-3 h-3"/></button>
                              <button onClick={e => { e.stopPropagation(); handleDelete(idx); }} className="p-1.5 hover:bg-red-50 rounded text-red-500"><Trash2 className="w-3 h-3"/></button>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        <div className="w-1/3 bg-white border-l flex flex-col no-print">
          <div className="px-4 py-3 border-b bg-slate-50 flex items-center justify-between">
            <div className="flex items-center gap-2 font-bold text-slate-700 text-sm">
              <BookOpen className="w-4 h-4 text-blue-500"/> Guidance Engine
            </div>
            
            {/* NEW TOGGLE UI */}
            <div className="flex items-center bg-slate-200 p-1 rounded-full cursor-pointer select-none" onClick={() => setLang(l => l === 'en' ? 'id' : 'en')}>
                <div className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all duration-200 ${lang === 'en' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-600'}`}>EN</div>
                <div className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all duration-200 ${lang === 'id' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-600'}`}>ID</div>
            </div>

          </div>
          <div className="flex-1 overflow-hidden">
            <GuidancePanel 
                section={activeSection} 
                moduleId={docData?.moduleId} 
                lang={lang} 
                onRunAI={() => handleGuidanceAI(selectedIdx)} 
                isProcessing={isProcessing}
                setLang={setLang}
            />
          </div>
        </div>
      </div>
    </div>
  );
}

createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
